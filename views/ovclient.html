{{ template "layout/base.html" . }}

{{define "head"}}
<title>Настройки клиента</title>
{{end}}

{{define "body"}}
<div class="card card-primary">
  <div class="card-header with-border">
    <h3 class="card-title">Шаблон конфигурации клиента для файла .opvn</h3>
    <div class="pull-right card-tools">
      <button type="button" class="btn btn-tool" data-card-widget="collapse">
      <i class="fa fa-minus"></i></button>
    </div>
  </div>
  <!-- /.card-header -->
  <!-- form start -->
  {{template "common/alert.html" .}}
  <div class="card-body">
    <p>Дополнительные пояснения по всем опциям ниже можно найти в официальной <a href="https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage" target="_blank">вики</a> или в официальном руководстве <a href="https://community.openvpn.net/openvpn/wiki/HOWTO" target="_blank">Howto</a>.</p>
  <form role="form" action="{{urlfor "OVClientConfigController.Post"}}" method="post">
    <div class="card-body">
      <!-- Disabled Profile - yet another feature to implement.
      <div class="form-group">
         <label for="name">Profile</label>
         <input type="text" class="form-control" name="Profile" id="Profile" value="{{ .Settings.Profile }}" style="visibility: hidden;" disabled>
     </div> -->

      <div class="form-group">
        <label for="name">Адрес подключения</label>
        <input type="text" class="form-control" id="ServerAddress" name="ServerAddress" placeholder="Введите адрес сервера"
          value="{{ .Settings.ServerAddress }}">
          <span id="helpBlock" class="text-muted">IP-адрес сервера или DNS-имя, которое будет использовать клиент для подключения. Если используется NAT по IP, можно указать внешний Internet-IP сервера.</span>
      </div>

      <div class="form-group">
        <label for="name">Порт подключения</label>
        <input type="text" class="form-control" id="OpenVpnServerPort" name="OpenVpnServerPort" placeholder="Введите внешний порт сервера"
          value="{{ .Settings.OpenVpnServerPort }}">
          <span id="helpBlock" class="text-muted">Порт сервера, используемый клиентом для подключения. Если используется NAT по порту, можно указать внешний Internet-порт сервера.</span>
      </div>

      <div class="form-group">
        <label for="name">Протокол (Proto)</label> <span id="helpBlock" class="text-muted">Не забудьте изменить конфигурацию на стороне сервера.</span>
        <input type="text" class="form-control" id="Proto" name="Proto" placeholder="Введите внешний протокол сервера"
          value="{{ .Settings.Proto }}">
      </div>

      <div class="form-group" id="auth-mode">
        <label>Режим аутентификации</label>
        <select name="FuncMode" id="FuncMode" class="form-control">
          <option value="0" {{if eq .Settings.FuncMode 0}}selected{{end}}>Классическая аутентификация (сертификат и опционально пароль)</option>
          <option value="1" {{if eq .Settings.FuncMode 1}}selected{{end}}>Двухфакторная аутентификация (2FA)</option>
        </select>
      </div>
  
      <div class="form-group" id="tfa-issuer">
        <label for="name">Строка издателя 2FA</label> 
        <input type="text" class="form-control" id="tfaissuer" name="TFAIssuer" placeholder="MFA%20OpenVPN-UI"
          value="{{if eq .Settings.FuncMode 0}}{{else}}{{ .Settings.TFAIssuer }}{{ end }}">
          <span id="helpBlock" class="text-muted">Строка издателя 2FA для QR-кода клиента.</span>
      </div>

      <div class="form-group" id="a-user-pass">
        <label for="name">AuthUserPass</label> 
        <input type="text" class="form-control" id="authuserpass" name="AuthUserPass" placeholder="AuthUserPass"
          value="{{if eq .Settings.FuncMode 0}} {{else}}auth-user-pass{{ end }}">
          <span id="helpBlock" class="text-muted">Используется для задания специфического процесса аутентификации пользователя (2FA, RADIUS и т. п.).</span>
      </div>

      <div class="form-group">
        <label for="name">Redirect Gateway</label> <!-- strong><span style="color:#337ab7" title="&quot;redirect-gateway def1&quot;">!</span></strong --><span id="helpBlock" class="text-muted" style="font-size: 80%;"> Закомментируйте строку, если она не нужна: «#redirect-gateway def1»</span>
        <input type="text" class="form-control" id="RedirectGateway" name="RedirectGateway" placeholder="redirect-gateway def1"
          value="{{ .Settings.RedirectGateway }}">
          <span id="helpBlock" class="text-muted">Используется для перенаправления всего трафика клиента через сервер OpenVPN.</span>
      </div>

      <div class="form-group">
        <label for="name">Resolv-retry</label> <!--strong><span style="color:#337ab7" title="&quot;resolv-retry infinite&quot;">!</span></strong--><span id="helpBlock" class="text-muted" style="font-size: 80%;"> Закомментируйте строку, если она не нужна: «#resolv-retry infinite»</span>
        <input type="text" class="form-control" id="ResolveRetry" name="ResolveRetry" placeholder="resolv-retry infinite"
          value="{{ .Settings.ResolveRetry }}"> 
      </div>

      <div class="form-group">
        <label for="name">User</label> <span id="helpBlock" class="text-muted">(кроме Windows)</span> <!--span style="color:#337ab7" title="&quot;nobody&quot;"><strong>!</strong></span -->
        <input type="text" class="form-control" id="OVClientUser" name="OVClientUser" placeholder="nobody"
          value="{{ .Settings.OVClientUser }}">
      </div>

      <div class="form-group">
        <label for="name">Group</label> <span id="helpBlock" class="text-muted">(кроме Windows)</span> <!--span style="color:#337ab7" title="&quot;nobody&quot;"><strong>!</strong></span -->
        <input type="text" class="form-control" id="OVClientGroup" name="OVClientGroup" placeholder="nogroup"
          value="{{ .Settings.OVClientGroup }}">
      </div>

      <div class="form-group">
        <label for="name">Persist-tun</label> <!--strong><span style="color:#337ab7" title="&quot;persist-tun&quot;">!</span></strong--><span id="helpBlock" class="text-muted" style="font-size: 80%;"> Закомментируйте строку, если она не нужна: «#persist-tun»</span>
        <input type="text" class="form-control" id="PersistTun" name="PersistTun" placeholder="persist-tun"
          value="{{ .Settings.PersistTun }}">
      </div>

      <div class="form-group">
        <label for="name">Persist-key</label> <!--strong><span style="color:#337ab7" title="&quot;persist-key&quot;">!</span></strong --><span id="helpBlock" class="text-muted" style="font-size: 80%;"> Закомментируйте строку, если она не нужна: «#persist-key»</span>
        <input type="text" class="form-control" id="PersistKey" name="PersistKey" placeholder="persist-key"
          value="{{ .Settings.PersistKey }}">
      </div>

      <div class="form-group">
        <label for="name">Remote-cert-tls</label> <!--strong><span style="color:#337ab7" title="&quot;remote-cert-tls server&quot;">!</span></strong --><span id="helpBlock" class="text-muted" style="font-size: 80%;"> Закомментируйте строку, если она не нужна: «#remote-cert-tls server»</span>
        <input type="text" class="form-control" id="RemoteCertTLS" name="RemoteCertTLS" placeholder="remote-cert-tls server"
          value="{{ .Settings.RemoteCertTLS }}">
      </div>

      <div class="form-group">
        <label for="name">Cipher</label> <span id="helpBlock" class="text-muted">Не забудьте изменить конфигурацию на стороне сервера.</span>
        <input type="text" class="form-control" id="Cipher" name="Cipher" placeholder="kuznyechik-cbc"
          value="{{ .Settings.Cipher }}">
      </div>

      <div class="form-group">
        <label for="name">Auth</label> <span id="helpBlock" class="text-muted">Не забудьте изменить конфигурацию на стороне сервера.</span>
        <input type="text" class="form-control" id="Auth" name="Auth" placeholder="id-tc26-gost3411-12-256"
          value="{{ .Settings.Auth }}">
      </div>

      <div class="form-group">
        <label for="name">Auth-nocache</label> <!--strong><span style="color:#337ab7" title="&quot;auth-nocache&quot;">!</span></strong --><span id="helpBlock" class="text-muted" style="font-size: 80%;"> Закомментируйте строку, если она не нужна: «#auth-nocache»</span>
        <input type="text" class="form-control" id="AuthNoCache" name="AuthNoCache" placeholder="auth-nocache"
          value="{{ .Settings.AuthNoCache }}">
      </div>

      <div class="form-group">
        <label for="name">Tls-client</label> <!--strong><span style="color:#337ab7" title="&quot;tls-client&quot;">!</span></strong --><span id="helpBlock" class="text-muted" style="font-size: 80%;"> Закомментируйте строку, если она не нужна: «#tls-client»</span>
        <input type="text" class="form-control" id="TlsClient" name="TlsClient" placeholder="tls-client"
          value="{{ .Settings.TlsClient }}">
      </div>

      <div class="form-group">
        <label for="name">Уровень детализации логов клиента</label> <!--strong><span style="color:#337ab7" title="&quot;3&quot;">!</span></strong -->
        <input type="text" class="form-control" id="Verbose" name="Verbose" placeholder="3"
          value="{{ .Settings.Verbose }}">
          <span id="helpBlock" class="text-muted">От 0 до 4, где 0 — без логов, 4 — максимальная подробность.</span>
      </div>

      <div class="form-group">
        <label for="name">Произвольная опция шаблона клиента №1</label> 
        <input type="text" class="form-control" id="CustomConfOne" name="CustomConfOne" placeholder="#Custom Option One"
          value="{{ .Settings.CustomConfOne }}">
          <span id="helpBlock" class="text-muted">Произвольная опция для шаблона клиента. Можно указать что угодно. Полный формат опции (для отключения — закомментируйте #).</span>
      </div>

      <div class="form-group">
        <label for="name">Произвольная опция шаблона клиента №2</label> 
        <input type="text" class="form-control" id="CustomConfTwo" name="CustomConfTwo" placeholder="#Custom Option Two"
          value="{{ .Settings.CustomConfTwo }}">
          <span id="helpBlock" class="text-muted">Произвольная опция для шаблона клиента. Можно указать что угодно. Полный формат опции (для отключения — закомментируйте #).</span>
      </div>

      <div class="form-group">
        <label for="name">Произвольная опция шаблона клиента №3</label> 
        <textarea class="form-control" name="CustomConfThree" id="CustomConfThree" placeholder="#Custom Option Three" 
         rows="2">{{ .Settings.CustomConfThree }}</textarea>
          <span id="helpBlock" class="text-muted">Произвольная опция для шаблона клиента. Можно указать что угодно. Полный формат опции (для отключения — закомментируйте #).</span>
      </div>

     <!--  comented out to avoid client/server confusion
      <div class="form-group">
        <label for="name">Device type</label>
        <input type="text" class="form-control" id="Device" name="Device" placeholder="tun"
          value="{{ .Settings.Device }}">
      </div>

      <div class="form-group">
        <label for="name">Protocol</label>
        <input type="text" class="form-control" id="Proto" name="Proto" placeholder="udp"
          value="{{ .Settings.Proto }}">
      </div>

     -->
      {{ .xsrfdata }}

      <button type="submit" style="width: 125px;" class="btn btn-primary" onclick="return confirm('Вы уверены, что хотите сохранить новый конфигурационный файл?\nТекущая конфигурация будет перезаписана!');">Сохранить</button> &nbsp; &nbsp;
      <button type="button" style="width: 125px;" class="btn btn-primary" data-toggle="modal" data-target="#config-view-modal">Просмотреть</button>
    </div>
        <!-- /.card-body -->
  </form>
</div>
</div>

<div class="modal fade" id="config-view-modal">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">{{ .BeeSettings.OVConfigPath }}/config/client.conf</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
          <span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
           <!-- /.card-header -->
            <!-- form start -->
           {{template "common/alert.html" .}}
            <form role="server-config" role="form" action="{{urlfor "OVClientConfigController.Edit"}}" method="post">
              <div class="card-body">
              
                <div class="form-group">
                    <!--div class="card-group" id="accordion">
                      <span >
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" class="collapsed">
                          <i class="fa fa-fw fa-info-circle" style="color: #f39c12; font-size: 15px;"></i> <b style="color: #f39c12;">Please note</b>
                        </a>
                      </span>
                    </div-->
                    <!--div id="collapseOne" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
                      <div class="card-body">
                        <span class="text-muted">Manual configuration will not push new changes into OpenVPN UI templates DB.</span><br>
                        <span class="text-muted">Best practice is update Client template with Client configuration template.</span><br>
                      </div>
                    </div-->
                    <br><textarea type="text" class="form-control my-textarea" name="ClientTemplate" id="ClientTemplate" spellcheck="false" rows="15">{{ .ClientTemplate }}</textarea>
                </div>
                
                {{ .xsrfdata }}

                <button type="button" class="btn btn-default pull-left" style="width: 135px;" data-dismiss="modal">Закрыть</button> &nbsp; &nbsp;
                <!--button type="submit" class="btn btn-primary" style="width: 135px;" onclick="return confirm('Are you sure you want to Save updated configuration file?\nTemplate will not be updated!'); window.location.reload();">Save</button-->
              </div>
                 <!-- /.card-body -->
            </form>
            <span class="text-muted"> {{template "common/fvalid.html" field_error_message .validation "Name" }}</span>
      </div>
    </div>
  </div>
</div>

<div class="card card-default">
  <!-- /.card-body -->
  <!-- /.card-header -->
  <!-- form start -->
  <div class="card-body">
  <form role="form" action="{{urlfor "OVClientConfigController.Post"}}" method="post">
    {{ .xsrfdata }}
    <div class="card-boddy">
      <a href="javascript:$.MyAPP.Restart('SIGUSR1')" class="btn btn-warning btn-primary" style="width: 135px;" title="Условный перезапуск (SIGUSR1)">Перезапустить сервер</a>
      <span style="color:grey;"> &nbsp; Условный перезапуск сервера OpenVPN применит новую конфигурацию и переинициализирует все активные клиентские сессии.</span> 
    </div>
      <!-- /.card-body -->
  </form>
</div>
</div>
<!-- /.card -->
{{end}}

<script>
  const funcModeSelect = document.getElementById('FuncMode');
  const authUserPass = document.getElementById('a-user-pass');
  const tFAIssuer = document.getElementById('tfa-issuer');
  const authUserPassInput = document.getElementById('authuserpass');
  const tFAIssuerInput = document.getElementById('tfaissuer');

  function checkFuncMode() {
    if (funcModeSelect.value === '0') {
      authUserPass.style.display = 'none';
      tFAIssuer.style.display = 'none';
      authUserPassInput.value = ' ';
     // tFAIssuerInput = ' ';
    } else {
      authUserPass.style.display = 'block';
      tFAIssuer.style.display = 'block';
      authUserPassInput.value = 'auth-user-pass';
      //tFAIssuerInput.value = 'MFA%20OpenVPN-UI';
    }
  }
  funcModeSelect.addEventListener('change', checkFuncMode);

window.addEventListener('load', () => {
    // Проверить «theme» в localStorage
  checkFuncMode();
  if (localStorage.getItem("theme") === "dark") {
    createEditor("ClientTemplate", "550px", "clouds_midnight", "ovpn", true);
  } else {
    createEditor("ClientTemplate", "550px", "clouds", "ovpn", true);
  }
});
</script>
