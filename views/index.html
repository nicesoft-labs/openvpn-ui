{{ template "layout/base.html" . }}

{{define "head"}}
<title>NiceSOFT NiceVPN UI — Сводка</title>
<style>
  /* ===== Корпоративный нейтральный стиль ===== */
  .kpi-box{border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,.05); padding:16px; background:#fff; height:100%}
  .kpi-box__title{font-size:.9rem; color:#6c757d; margin-bottom:.25rem}
  .kpi-box__value{font-size:1.6rem; font-weight:700; line-height:1.1}
  .kpi-box__muted{color:#6c757d; font-size:.9rem}
  .card-clean{border:1px solid #e9ecef; border-radius:14px; background:#fff; box-shadow:0 3px 10px rgba(0,0,0,.04)}
  .card-clean .card-header{border-bottom:1px solid #eef1f4; background:#fff; border-top-left-radius:14px; border-top-right-radius:14px}
  .card-clean .card-body{padding:16px}
  .metric-card{border:1px solid #e9ecef; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.03); background:#fff}
  .metric-card__header{font-weight:600; margin-bottom:8px}
  .metric-card .chart-wrap{position:relative; height:220px}
  .metric-card canvas{width:100% !important; height:100% !important}
  .status-pill{display:inline-flex; align-items:center; padding:5px 12px; border-radius:999px; font-weight:700; font-size:.9rem; color:#fff; letter-spacing:.03em; text-transform:uppercase}
  .pill-ok{background:#28a745}
  .pill-warn{background:#ffc107; color:#212529}
  .pill-bad{background:#dc3545}
  .small-muted{font-size:.85rem; color:#6c757d}
  .empty-state{display:none; align-items:center; justify-content:center; height:220px; border:2px dashed #e9ecef; border-radius:10px; color:#6c757d; font-size:.95rem; background:#fafafa}
  .empty-state .hint{font-size:.85rem; color:#9aa0a6; margin-left:.5rem}
  .progress-xs{height:10px}
  .progress-number{font-weight:600}
  .table thead th{white-space:nowrap}
  .button-transparent{background:transparent;border:0;padding:0;margin-left:6px}
  .clippy{opacity:.6}
  .clippy:hover{opacity:1}
</style>
{{end}}

{{define "body"}}

<!-- ===== Верхние KPI ===== -->
<div class="row">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Подключённые клиенты</div>
      <div class="kpi-box__value">{{ if .ovstats }}{{ .ovstats.NClients }}{{ else }}0{{ end }}</div>
      <div class="kpi-box__muted">
        Вход: {{ if .ovstats }}{{ printmb .ovstats.BytesIn }}{{ else }}0{{ end }} MB •
        Выход: {{ if .ovstats }}{{ printmb .ovstats.BytesOut }}{{ else }}0{{ end }} MB
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Нагрузка (Load Average)</div>
      <div class="kpi-box__value">1м: {{ .sysinfo.LoadAvg.One }}</div>
      <div class="kpi-box__muted">5м: {{ .sysinfo.LoadAvg.Five }} • 15м: {{ .sysinfo.LoadAvg.Fifteen }}</div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Аптайм ОС</div>
      <div class="kpi-box__value">{{ .sysinfo.UptimeS }}</div>
      <div class="kpi-box__muted">Стабильность хоста</div>
      <div>OpenVPN PID: <span class="kpi-box__value">{{ if .ovpid }}{{ .ovpid }}{{ else }}0{{ end }}</span></div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Процессы</div>
      <div class="kpi-box__value" id="process-count">{{ .sysinfo.Processes }}</div>
      <div class="kpi-box__muted">Ядер CPU: <span id="cpu-count">{{ .sysinfo.CPUCount }}</span></div>
    </div>
  </div>
</div>

<!-- ===== Память / Swap ===== -->
<h5 class="mt-2 mb-2">Память</h5>
<div class="row">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            ОЗУ: <b>{{ printmb .sysinfo.Memory.Used }}</b> / {{ printmb .sysinfo.Memory.Total }} MB — {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-primary progress-bar-striped" style="width: {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            Swap: <b>{{ printmb .sysinfo.Swap.Used }}</b> / {{ printmb .sysinfo.Swap.Total }} MB — {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-secondary progress-bar-striped" style="width: {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%"></div>
          </div>
          {{ if eq .sysinfo.Swap.Total 0 }}
            <div class="small text-warning mt-2">Swap отключён — рекомендовано включить (zram).</div>
          {{ end }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== CPU / Диски ===== -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header d-flex justify-content-between">
        <span>Нагрузка CPU по ядрам</span>
        <span class="small-muted">В процентах</span>
      </div>
      <div class="chart-wrap">
        <canvas id="cpuUsageChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="cpuUsageChart">Нет данных CPU<span class="hint"> (метрика недоступна)</span></div>
      <small class="text-muted d-block mt-2">Доля активного времени (busy %) на ядро.</small>
    </div>
  </div>
  <!-- ===== График: суммарный трафик OpenVPN ===== -->
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">
        Суммарный трафик OpenVPN
        <small class="text-secondary d-block">openvpn_server_bytes_*_total</small>
      </div>
      <div class="chart-wrap">
        <canvas id="serverTotalsChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="serverTotalsChart">Нет данных<span class="hint"> (подключите management/status)</span></div>
      <small class="text-muted d-block mt-2">Источник: management (load-stats) / status.</small>
    </div>
  </div>
</div>

  <div class="row">
    <div class="col-md-12">
      <div class="metric-card">
        <div class="metric-card__header d-flex justify-content-between">
          <span>Использование файловых систем</span>
        <span class="small-muted">Заполненность</span>
      </div>
      <div class="chart-wrap">
        <canvas id="fsUsageChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="fsUsageChart">Нет данных по дискам<span class="hint"> (мониторинг отключен)</span></div>
      <small class="text-muted d-block mt-2">Процент использования по точкам монтирования.</small>
    </div>
  </div>
</div>

<!-- ===== Сеть: сводка и графики ===== -->
<h5 class="mt-3 mb-2">Сеть</h5>

<!-- KPI по сети -->
<div class="row">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">TCP сокеты</div>
      <div class="kpi-box__value" id="kpi-tcp-inuse">—</div>
      <div class="kpi-box__muted">inuse / tw / orphan</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">UDP сокеты</div>
      <div class="kpi-box__value" id="kpi-udp-inuse">—</div>
      <div class="kpi-box__muted">inuse, mem (pages)</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Conntrack</div>
      <div class="kpi-box__value" id="kpi-ct-used">—</div>
      <div class="kpi-box__muted">count / max</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">TCP состояния</div>
      <div class="kpi-box__value" id="kpi-tcp-total">—</div>
      <div class="kpi-box__muted">total sockets</div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Conntrack usage -->
  <div class="col-lg-4 col-md-6 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Conntrack usage</div>
      <div class="chart-wrap"><canvas id="conntrackGauge"></canvas></div>
      <div class="empty-state" data-empty-for="conntrackGauge">Нет данных conntrack</div>
    </div>
  </div>

  <!-- Softnet per-CPU -->
  <div class="col-lg-8 col-md-6 mb-4">
    <div class="metric-card">
      <div class="metric-card__header d-flex justify-content-between">
        <span>Softnet per-CPU</span>
        <span class="small-muted">dropped / time_squeezed</span>
      </div>
      <div class="chart-wrap"><canvas id="softnetChart"></canvas></div>
      <div class="empty-state" data-empty-for="softnetChart">Нет данных softnet</div>
    </div>
  </div>
</div>

<div class="row">
  <!-- TCP States -->
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">TCP состояния</div>
      <div class="chart-wrap"><canvas id="tcpStatesChart"></canvas></div>
      <div class="empty-state" data-empty-for="tcpStatesChart">Нет данных TCP</div>
    </div>
  </div>

  <!-- TCP топ портов -->
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">TCP: топ портов по RX/TX-очередям</div>
      <div class="chart-wrap"><canvas id="tcpTopPortsChart"></canvas></div>
      <div class="empty-state" data-empty-for="tcpTopPortsChart">Нет данных TCP портов</div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Interfaces RX/TX -->
  <div class="col-lg-8 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Интерфейсы: RX/TX (MB)</div>
      <div class="chart-wrap"><canvas id="ifaceRxTxChart"></canvas></div>
      <div class="empty-state" data-empty-for="ifaceRxTxChart">Нет данных по интерфейсам</div>
      <small class="text-muted d-block mt-2">Показывает объёмы RX/TX по интерфейсам eth*/en*/tun*/tap*/wg*.</small>
    </div>
  </div>

  <!-- UDP Health -->
  <div class="col-lg-4 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">UDP Health</div>
      <div class="chart-wrap"><canvas id="udpHealthChart"></canvas></div>
      <div class="empty-state" data-empty-for="udpHealthChart">Нет данных UDP</div>
      <small class="text-muted d-block mt-2">Ключевые счётчики: In/OutDatagrams, NoPorts, InErrors, Rcvbuf/SndbufErrors, IgnoredMulti.</small>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-12 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">UDP: топ портов по RX/TX-очередям</div>
      <div class="chart-wrap"><canvas id="udpTopPortsChart"></canvas></div>
      <div class="empty-state" data-empty-for="udpTopPortsChart">Нет данных UDP портов</div>
    </div>
  </div>
</div>

<!-- Таблица: ключевые сетевые показатели -->
<div class="card-clean mt-2">
  <div class="card-header">
    <h3 class="card-title" style="margin:0">Сетевые показатели (снимок)</h3>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm" id="net-kpis-table">
        <thead>
          <tr>
            <th>Категория</th>
            <th>Показатель</th>
            <th>Значение</th>
            <th>Комментарий</th>
          </tr>
        </thead>
        <tbody>
          <!-- Заполняется JS: renderNetKPIs(netinfoData) -->
        </tbody>
      </table>
    </div>
    <div id="net-warnings" class="mt-2"></div>
  </div>
</div>

<!-- ===== Таблица клиентов ===== -->
<div class="row mt-3">
  <div class="col-md-12">
    <div class="card-clean">
      <div class="card-header"><h3 class="card-title" style="margin:0">Подключённые клиенты</h3></div>
      <div class="card-body">
        {{if .ovstatus}}
          {{if gt (len .ovstatus.ClientList) 0}}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>CN</th><th>Реальный адрес</th><th>Вирт. адрес</th>
                    <th class="text-right">KB вход</th><th class="text-right">KB выход</th>
                    <th>Сессия с</th><th>Пользователь</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  {{range .ovstatus.ClientList}}
                  <tr>
                    <td>{{.CommonName}}</td>
                    <td>{{.RealAddress}}</td>
                    <td>
                      <span class="badge bg-success">{{.VirtualAddress}}</span>
                      <button class="button-transparent button-copy" data-clipboard-text="{{.VirtualAddress}}">
                        <img class="clippy" src="static/img/clippy.svg" width="13" alt="Copy">
                      </button>
                    </td>
                    <td class="text-right">{{printkb .BytesReceived}}</td>
                    <td class="text-right">{{printkb .BytesSent}}</td>
                    <td>{{.ConnectedSince}}</td>
                    <td>{{if eq .Username "UNDEF"}}-{{else}}{{.Username}}{{end}}</td>
                    <td><a href="javascript:$.MyAPP.Disconnect('{{.CommonName}}')" class="btn btn-xs btn-danger" title="Отключить">Откл.</a></td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
          {{else}}
            <div class="empty-state" style="display:flex; height:140px">Клиентов нет<span class="hint"> (активных сессий не обнаружено)</span></div>
          {{end}}
        {{else}}
          <div class="empty-state" style="display:flex; height:140px">Нет данных статуса<span class="hint"> (проверьте management/status)</span></div>
        {{end}}
      </div>
    </div>
  </div>
</div>

<!-- ===== Версия / ОС ===== -->
<div class="row mt-3">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body d-flex align-items-center">
        <img src="/static/img/openvpn-win.svg" alt="OpenVPN" width="40" height="40" style="opacity:.7; margin-right:12px">
        <div>
          <div class="kpi-box__title">Версия OpenVPN</div>
          <!-- Важно: печатаем .ovversion целиком, чтобы не падать на interface{} -->
          <div class="kpi-box__value" style="font-size:1.2rem">{{ .ovversion }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="kpi-box__title">Операционная система</div>
        <div class="kpi-box__value" style="font-size:1.2rem">{{ .sysinfo.Os }}</div>
        <div class="kpi-box__muted">Архитектура: {{ .sysinfo.Arch }}</div>
        <div class="kpi-box__muted">Хост: <span id="host-name">{{ .sysinfo.Hostname }}</span></div>
        <div class="kpi-box__muted">Загружен: <span id="boot-time">{{ .sysinfo.BootTime }}</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Отладка системных метрик ===== -->
<div class="card-clean mt-3">
  <div class="card-header"><h3 class="card-title" style="margin:0">Отладка системной информации</h3></div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-4 mb-3">
        <div class="small-muted">Текущее время: <span id="current-time">{{ .sysinfo.CurrentTime }}</span></div>
        <div class="small-muted">Аптайм: <span id="debug-uptime">{{ .sysinfo.UptimeS }}</span></div>
        <div class="small-muted">Процессы: <span id="debug-processes">{{ .sysinfo.Processes }}</span></div>
      </div>
      <div class="col-md-8">
        <pre id="sysinfo-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .sysinfo }}</pre>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-12">
        <div class="small-muted mb-2">Все полученные метрики</div>
        <pre id="metrics-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .metrics }}</pre>
      </div>
    </div>
  </div>
</div>

<!-- ===== Скрипты (без опросов) ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const ovstats     = {{ tojson .ovstats  }} || {};
  const sysinfoData = {{ tojson .sysinfo  }} || {};
  const netinfoData = {{ tojson .netinfo  }} || {};

  const palette = ['#17a2b8', '#28a745', '#6f42c1', '#ffc107', '#e83e8c', '#20c997'];
  const CHARTS = {};
  function destroyChart(id){ if (CHARTS[id]) { try { CHARTS[id].destroy(); } catch(e){} delete CHARTS[id]; } }
  function showEmpty(id, show=true){
    const canvas = document.getElementById(id);
    const empty = document.querySelector(`[data-empty-for="${id}"]`);
    if (canvas) canvas.style.display = show ? 'none' : 'block';
    if (empty)  empty.style.display  = show ? 'flex' : 'none';
  }
  function isAllZeroOrEmpty(arr){ return !arr || !arr.length || arr.every(v => v===null || v===undefined || v===0); }
  function renderBarOrEmpty({id, labels, datasets, stacked=false}){
    if (!labels || !labels.length || !datasets || datasets.length===0 || datasets.every(ds => isAllZeroOrEmpty(ds.data))){
      destroyChart(id); showEmpty(id, true); return;
    }
    showEmpty(id, false);
    const ctx = document.getElementById(id); if (!ctx) return;
    destroyChart(id);
    CHARTS[id] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: { responsive:true, maintainAspectRatio:false, animation:false,
        scales:{ x:{ stacked }, y:{ stacked, beginAtZero:true } },
        plugins:{ legend:{ position:'bottom' } } }
    });
  }

  function renderCpuUsage(info){
    const list = (info && info.cpuList && info.cpuList.List) || [];
    const labels = list.map((_, i) => `CPU${i}`);
    const data = list.map(cpu => {
      const total = (cpu?.User||0)+(cpu?.Sys||0)+(cpu?.Nice||0)+(cpu?.Idle||0)+(cpu?.Wait||0)+(cpu?.Irq||0)+(cpu?.SoftIrq||0)+(cpu?.Stolen||0);
      if (!total) return 0;
      const busy = total - (cpu?.Idle||0);
      return Math.round((busy/total)*1000)/10;
    });
    renderBarOrEmpty({ id:'cpuUsageChart', labels, datasets:[{ label:'Загрузка (%)', data, backgroundColor:palette[0] }] });
  }

  function renderFsUsage(info){
    const fsList = (info && info.fs) || [];
    const labelOf = (fs) => fs.mount || fs.Mount || fs.device || fs.Device || 'fs';
    const usedPctOf = (fs) => (fs.usedPercent ?? fs.UsedPercent ?? 0);
    const labels = fsList.map(labelOf);
    const data   = fsList.map(fs => Math.round(usedPctOf(fs)*10)/10);
    renderBarOrEmpty({ id:'fsUsageChart', labels, datasets:[{ label:'Использовано (%)', data, backgroundColor:palette[2] }] });
  }

  function renderServerTotals(stats){
    const inMB  = ((stats && stats.BytesIn)  || 0) / 1024 / 1024;
    const outMB = ((stats && stats.BytesOut) || 0) / 1024 / 1024;
    renderBarOrEmpty({ id:'serverTotalsChart', labels:['Вход','Выход'],
      datasets:[{ label:'MB', data:[inMB,outMB], backgroundColor:[palette[0],palette[1]] }] });
  }

  // Единоразовый рендер
  renderCpuUsage(sysinfoData);
  renderFsUsage(sysinfoData);
  renderServerTotals(ovstats);

  // Утилиты
  function showEmpty(id, show=true){
    const canvas = document.getElementById(id);
    const empty = document.querySelector(`[data-empty-for="${id}"]`);
    if (canvas) canvas.style.display = show ? 'none' : 'block';
    if (empty)  empty.style.display  = show ? 'flex' : 'none';
  }
  function destroyIfExists(store, id){
    if (store[id]) { try { store[id].destroy(); } catch(e){} delete store[id]; }
  }
  function mb(x){ return Math.round((Number(x||0)/1024/1024)*10)/10; }
  function percent(part, total){ if (!total) return 0; return Math.max(0, Math.min(100, (part/total)*100)); }
  const CHARTS2 = {};

  function renderConntrackGauge(netinfo){
    const cnt = Number(netinfo?.conntrack?.count||0);
    const max = Number(netinfo?.conntrack?.max||0);
    const id = 'conntrackGauge';
    if (!max) { showEmpty(id, true); return; }
    const used = Math.min(percent(cnt, max), 100);
    const free = 100 - used;
    showEmpty(id, false);
    const ctx = document.getElementById(id); if(!ctx) return;
    destroyIfExists(CHARTS2, id);
    CHARTS2[id] = new Chart(ctx, {
      type:'bar',
      data:{ labels:['Conntrack'], datasets:[
        {label:'Used %', data:[used]},
        {label:'Free %', data:[free]}
      ]},
      options:{
        indexAxis:'y', responsive:true, maintainAspectRatio:false,
        animation:false,
        scales:{x:{stacked:true, beginAtZero:true, max:100}, y:{stacked:true}},
        plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{
          label:(c)=> `${c.dataset.label}: ${c.parsed.x.toFixed(1)}% (${cnt}/${max})`
        }}}
      }
    });
  }

  function renderSoftnetBars(netinfo){
    const per = netinfo?.softnet?.per_cpu||[];
    const id = 'softnetChart';
    if (!per.length){ showEmpty(id,true); return; }
    const labels = per.map(x=>'CPU'+x.cpu);
    const dropped = per.map(x=> Number(x.dropped||0));
    const tsq = per.map(x=> Number(x.time_squeezed||0));
    showEmpty(id,false);
    const ctx = document.getElementById(id); if(!ctx) return;
    destroyIfExists(CHARTS2, id);
    CHARTS2[id] = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[
        {label:'dropped', data:dropped},
        {label:'time_squeezed', data:tsq}
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        scales:{x:{stacked:true}, y:{stacked:false, beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  function renderIfaceRxTx(netinfo){
    const id = 'ifaceRxTxChart';
    const skip = n => !n || n==='lo' || n.startsWith('docker') || n.startsWith('veth') || n.startsWith('br-');
    const keep = n => ['eth','en','tun','tap','wg'].some(p => n.startsWith(p));
    const ifaces = (netinfo?.ifaces||[]).filter(x => keep(x.name) && !skip(x.name));
    if (!ifaces.length){ showEmpty(id,true); return; }
    const labels = ifaces.map(x=>x.name);
    const rx = ifaces.map(x=> ((x.rx_bytes||0)/1048576).toFixed(1)*1);
    const tx = ifaces.map(x=> ((x.tx_bytes||0)/1048576).toFixed(1)*1);
    if (rx.concat(tx).every(v=>v===0)){ showEmpty(id,true); return; }
    showEmpty(id,false);
    const ctx = document.getElementById(id); if(!ctx) return;
    destroyIfExists(CHARTS2, id);
    CHARTS2[id] = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[
        {label:'RX MB', data:rx},
        {label:'TX MB', data:tx}
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  function renderUdpHealth(netinfo){
    const u = netinfo?.snmp?.udp||{};
    const id = 'udpHealthChart';
    const keys = ['InDatagrams','OutDatagrams','NoPorts','InErrors','RcvbufErrors','SndbufErrors','IgnoredMulti'];
    const vals = keys.map(k => Number(u[k]||0));
    const allZero = !vals.length || vals.every(v=>v===0);
    if (allZero){ showEmpty(id,true); return; }
    showEmpty(id,false);
    const ctx = document.getElementById(id); if(!ctx) return;
    destroyIfExists(CHARTS2, id);
    CHARTS2[id] = new Chart(ctx, {
      type:'bar',
      data:{ labels: keys, datasets:[{label:'count', data: vals}]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{legend:{display:false}}
      }
    });
  }

  function setCellBadge(val, dangerIfGtZero=true){
    const v = Number(val||0);
    if (dangerIfGtZero && v>0) return `<span class="badge bg-danger">${v}</span>`;
    return v===0 ? `<span class="badge bg-success">0</span>` : String(v);
  }

  function tbodyAdd(tbody, cat, key, value, note){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${cat}</td><td>${key}</td><td>${value}</td><td class="small-muted">${note||''}</td>`;
    tbody.appendChild(tr);
  }

  function renderNetKPIs(netinfo){
    const tb = document.querySelector('#net-kpis-table tbody'); if(!tb) return;
    tb.innerHTML='';

    const add=(cat,key,val,note)=>{ const tr=document.createElement('tr');
      tr.innerHTML=`<td>${cat}</td><td>${key}</td><td>${val}</td><td class="small-muted">${note||''}</td>`;
      tb.appendChild(tr);
    };
    const badge=(v,dangerIfGtZero=true)=>{ v=Number(v||0); if(dangerIfGtZero&&v>0)return `<span class="badge bg-danger">${v}</span>`; return v===0?`<span class="badge bg-success">0</span>`:String(v); };

    const snmp = netinfo?.snmp||{};
    const udp  = snmp.udp||{}, udp6=snmp.udp6||{};
    const te   = snmp.tcpext||{};
    // UDP v4
    add('UDP','InDatagrams',udp.InDatagrams??'—','v4'); add('UDP','OutDatagrams',udp.OutDatagrams??'—','v4');
    add('UDP','NoPorts',badge(udp.NoPorts,false),'v4'); add('UDP','InErrors',badge(udp.InErrors),'v4');
    add('UDP','RcvbufErrors',badge(udp.RcvbufErrors),'v4'); add('UDP','SndbufErrors',badge(udp.SndbufErrors),'v4');
    // UDP v6 (если есть)
    if (Object.keys(udp6).length){
      add('UDP6','InDatagrams',udp6.InDatagrams??'—','v6'); add('UDP6','OutDatagrams',udp6.OutDatagrams??'—','v6');
      if (udp6.NoPorts!==undefined) add('UDP6','NoPorts',badge(udp6.NoPorts,false),'v6');
      if (udp6.InErrors!==undefined) add('UDP6','InErrors',badge(udp6.InErrors),'v6');
    }
    // TCP ext
    if (te.ListenOverflows!==undefined) add('TCP','ListenOverflows',badge(te.ListenOverflows),'переполнение accept()');
    if (te.ListenDrops!==undefined)     add('TCP','ListenDrops',badge(te.ListenDrops),'скидывали входящие');
    if (te.RetransSegs!==undefined)     add('TCP','RetransSegs',te.RetransSegs,'накопительно');
    if (te.TCPTimeouts!==undefined)     add('TCP','TCPTimeouts',te.TCPTimeouts,'RTO таймауты');

    // Conntrack
    const ct=netinfo?.conntrack||{}; const used=Number(ct.count||0), max=Number(ct.max||0);
    const usedPct = max? Math.round((used/max)*1000)/10 : 0;
    add('Conntrack','Count',used,'текущие записи');
    add('Conntrack','Max',max,'лимит');
    if (ct.buckets!==undefined) add('Conntrack','Buckets',ct.buckets,'хэш-ёмкость');
    add('Conntrack','Used %', max?(usedPct>=85?`<span class="badge bg-danger">${usedPct}%</span>`:usedPct):'—','использование пула');

    // Softnet total
    const st=netinfo?.softnet?.total||{};
    add('Softnet','Processed',st.processed??'—','обработано в softIRQ');
    add('Softnet','Dropped',badge(st.dropped),'потери до сокетов');
    add('Softnet','TimeSqueezed',st.time_squeezed??'—','давление по времени');

    // UDP mem limits
    const lim=netinfo?.udp_mem_limits||{};
    if (Array.isArray(lim.udp_mem) && lim.udp_mem.length===3){
      add('UDP mem','udp_mem (low/pressure/high)', `${lim.udp_mem[0]} / ${lim.udp_mem[1]} / ${lim.udp_mem[2]}`,'страницы');
    }
    add('UDP mem','udp_rmem_min', lim.udp_rmem_min??'—','байт');
    add('UDP mem','udp_wmem_min', lim.udp_wmem_min??'—','байт');
    add('Core mem','rmem_default / rmem_max', `${lim.core_rmem_default??'—'} / ${lim.core_rmem_max??'—'}`,'байт');
    add('Core mem','wmem_default / wmem_max', `${lim.core_wmem_default??'—'} / ${lim.core_wmem_max??'—'}`,'байт');

    // Sockstat v4+v6
    const s4=netinfo?.sock_stat||{}, s6=netinfo?.sock_stat6||{};
    const tcpIn=(s4.tcp?.inuse||0)+(s6.tcp?.inuse||0);
    const tcpTw=(s4.tcp?.tw||0)+(s6.tcp?.tw||0);
    const tcpOr=(s4.tcp?.orphan||0)+(s6.tcp?.orphan||0);
    add('Sockstat','TCP inuse / tw / orphan', `${tcpIn} / ${tcpTw} / ${tcpOr}`, '');
    const udpIn=(s4.udp?.inuse||0)+(s6.udp?.inuse||0);
    add('Sockstat','UDP inuse', udpIn, '');
    if (s4.sockets_inuse!==undefined) add('Sockstat','sockets_inuse (all)', s4.sockets_inuse, '');

    // Интерфейсы (eth0/tun0, если есть)
    const ifs=netinfo?.ifaces||[];
    const f = n => ifs.find(x=>x.name===n);
    ['eth0','tun0'].forEach(n=>{
      const it=f(n); if(!it) return;
      const rx=((it.rx_bytes||0)/1048576).toFixed(1), tx=((it.tx_bytes||0)/1048576).toFixed(1);
      const errs=(Number(it.rx_errors||0)+Number(it.tx_errors||0));
      const drops=(Number(it.rx_dropped||0)+Number(it.tx_dropped||0));
      add(`Iface ${n}`,'RX/TX (MB)', `${rx} / ${tx}`, 'накоп.');
      add(`Iface ${n}`,'Errors', badge(errs),'RX+TX'); add(`Iface ${n}`,'Dropped', badge(drops),'RX+TX');
      add(`Iface ${n}`,'Oper/MTU', `${it.operstate||'—'} / ${it.mtu||'—'}`, '');
    });

    // Предупреждения
    const w = netinfo?.warnings||[];
    const wEl=document.getElementById('net-warnings');
    if (wEl) wEl.innerHTML = w.length ? ('Предупреждения: ' + w.map(x=>`<span class="badge bg-warning text-dark me-1">${x}</span>`).join(' ')) : '';
  }

  // +++ KPI по сети из sock_stat/sock_stat6 и tcp_states + conntrack
  function renderNetKPI(d){
    const s4 = d?.sock_stat || {};
    const s6 = d?.sock_stat6 || {};
    const tcpIn = (s4.tcp?.inuse||0) + (s6.tcp?.inuse||0);
    const tcpTw = (s4.tcp?.tw||0)    + (s6.tcp?.tw||0);
    const tcpOr = (s4.tcp?.orphan||0)+(s6.tcp?.orphan||0);
    const udpIn = (s4.udp?.inuse||0) + (s6.udp?.inuse||0);
    const udpMem= (s4.udp?.mem||0)   + (s6.udp?.mem||0);

    const ctUsed = Number(d?.conntrack?.count||0);
    const ctMax  = Number(d?.conntrack?.max||0);
    const tcpTotal = Number(d?.tcp_states?.total||0);

    const set = (id, val) => { const el=document.getElementById(id); if (el) el.textContent = val; };
    set('kpi-tcp-inuse', `${tcpIn} / ${tcpTw} / ${tcpOr}`);
    set('kpi-udp-inuse', `${udpIn}, mem=${udpMem}`);
    set('kpi-ct-used',   ctMax ? `${ctUsed} / ${ctMax}` : '—');
    set('kpi-tcp-total', `${tcpTotal}`);
  }

  // +++ Пончик TCP состояний
  function renderTCPStatesChart(d){
    const id='tcpStatesChart';
    const st=d?.tcp_states||{};
    const labels=['LISTEN','ESTABLISHED','SYN-SENT','SYN-RECV','FIN-WAIT1','FIN-WAIT2','TIME-WAIT','CLOSE','CLOSE-WAIT','LAST-ACK','CLOSING','NEW-SYN-RECV','UNKNOWN'];
    const keys  =['listen','established','syn_sent','syn_recv','fin_wait1','fin_wait2','time_wait','close','close_wait','last_ack','closing','new_syn_recv','unknown'];
    const vals=keys.map(k=>Number(st[k]||0));
    if (!vals.length || vals.every(v=>v===0)){ destroyChart(id); showEmpty(id,true); return; }
    showEmpty(id,false);
    destroyChart(id);
    CHARTS[id]=new Chart(document.getElementById(id),{
      type:'doughnut',
      data:{labels,datasets:[{data:vals}]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{position:'bottom'}}}
    });
  }

  // +++ TCP топ портов по очередям
  function renderTcpTopPortsChart(d){
    const id='tcpTopPortsChart';
    const ps=d?.tcp_socket_stats?.port_stats||[];
    if (!ps.length){ destroyChart(id); showEmpty(id,true); return; }
    const labels=ps.map(p=>String(p.port));
    const rx=ps.map(p=>Number(p.rx_queue||0));
    const tx=ps.map(p=>Number(p.tx_queue||0));
    if (rx.concat(tx).every(v=>v===0)){ destroyChart(id); showEmpty(id,true); return; }
    showEmpty(id,false);
    destroyChart(id);
    CHARTS[id]=new Chart(document.getElementById(id),{
      type:'bar',
      data:{labels,datasets:[
        {label:'RX queue',data:rx},
        {label:'TX queue',data:tx},
      ]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{beginAtZero:true},y:{stacked:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  // +++ UDP топ портов по очередям + drops (линия, ось y2)
  function renderUdpTopPortsChart(d){
    const id='udpTopPortsChart';
    const ps=d?.udp_port_stats||[];
    if (!ps.length){ destroyChart(id); showEmpty(id,true); return; }
    const labels=ps.map(p=>String(p.port));
    const rx=ps.map(p=>Number(p.rx_queue||0));
    const tx=ps.map(p=>Number(p.tx_queue||0));
    const drops=ps.map(p=>Number(p.drops||0));
    if (rx.concat(tx).every(v=>v===0) && drops.every(v=>v===0)){ destroyChart(id); showEmpty(id,true); return; }
    showEmpty(id,false);
    destroyChart(id);
    CHARTS[id]=new Chart(document.getElementById(id),{
      type:'bar',
      data:{labels,datasets:[
        {label:'RX queue',data:rx},
        {label:'TX queue',data:tx},
        {type:'line',label:'drops',data:drops,yAxisID:'y2'}
      ]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{beginAtZero:true},y:{stacked:true},y2:{position:'right',beginAtZero:true,grid:{display:false}}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  // Рендер сетевого раздела из готового снапшота (без поллинга)
  renderNetKPI(netinfoData);
  renderConntrackGauge(netinfoData);
  renderSoftnetBars(netinfoData);
  renderTCPStatesChart(netinfoData);
  renderTcpTopPortsChart(netinfoData);
  renderIfaceRxTx(netinfoData);
  renderUdpHealth(netinfoData);
  renderUdpTopPortsChart(netinfoData);
  renderNetKPIs(netinfoData);

  // Копирование адресов (иконка-скрепка)
  (function(){
    const btns = document.querySelectorAll('.button-copy');
    btns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const txt = b.getAttribute('data-clipboard-text') || '';
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(()=> {
          const icon = b.querySelector('.clippy'); if (!icon) return;
          icon.style.opacity = 1; setTimeout(()=>{ icon.style.opacity = .6; }, 800);
        });
      });
    });
  })();
</script>

{{end}}
