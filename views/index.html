{{ template "layout/base.html" . }}

{{define "head"}}
<title>NiceSOFT NiceVPN UI — Сводка</title>
<style>
  /* ===== Корпоративный нейтральный стиль ===== */
  .kpi-box{border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,.05); padding:16px; background:#fff; height:100%}
  .kpi-box__title{font-size:.9rem; color:#6c757d; margin-bottom:.25rem}
  .kpi-box__value{font-size:1.6rem; font-weight:700; line-height:1.1}
  .kpi-box__muted{color:#6c757d; font-size:.9rem}
  .card-clean{border:1px solid #e9ecef; border-radius:14px; background:#fff; box-shadow:0 3px 10px rgba(0,0,0,.04)}
  .card-clean .card-header{border-bottom:1px solid #eef1f4; background:#fff; border-top-left-radius:14px; border-top-right-radius:14px}
  .card-clean .card-body{padding:16px}
  .metric-card{border:1px solid #e9ecef; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.03); background:#fff}
  .metric-card__header{font-weight:600; margin-bottom:8px}
  .metric-card .chart-wrap{position:relative; height:220px}
  .metric-card canvas{width:100% !important; height:100% !important}
  .status-pill{display:inline-flex; align-items:center; padding:5px 12px; border-radius:999px; font-weight:700; font-size:.9rem; color:#fff; letter-spacing:.03em; text-transform:uppercase}
  .pill-ok{background:#28a745}
  .pill-warn{background:#ffc107; color:#212529}
  .pill-bad{background:#dc3545}
  .small-muted{font-size:.85rem; color:#6c757d}
  .empty-state{display:none; align-items:center; justify-content:center; height:220px; border:2px dashed #e9ecef; border-radius:10px; color:#6c757d; font-size:.95rem; background:#fafafa}
  .empty-state .hint{font-size:.85rem; color:#9aa0a6; margin-left:.5rem}
  .progress-xs{height:10px}
  .progress-number{font-weight:600}
  .table thead th{white-space:nowrap}
  .button-transparent{background:transparent;border:0;padding:0;margin-left:6px}
  .clippy{opacity:.6}
  .clippy:hover{opacity:1}
</style>
{{end}}

{{define "body"}}

<!-- ===== Верхние KPI ===== -->
<div class="row">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Подключённые клиенты</div>
      <div class="kpi-box__value">{{ if .ovstats }}{{ .ovstats.NClients }}{{ else }}0{{ end }}</div>
      <div class="kpi-box__muted">
        Вход: {{ if .ovstats }}{{ printmb .ovstats.BytesIn }}{{ else }}0{{ end }} MB •
        Выход: {{ if .ovstats }}{{ printmb .ovstats.BytesOut }}{{ else }}0{{ end }} MB
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Нагрузка (Load Average)</div>
      <div class="kpi-box__value">1м: {{ .sysinfo.LoadAvg.One }}</div>
      <div class="kpi-box__muted">5м: {{ .sysinfo.LoadAvg.Five }} • 15м: {{ .sysinfo.LoadAvg.Fifteen }}</div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Аптайм ОС</div>
      <div class="kpi-box__value">{{ .sysinfo.UptimeS }}</div>
      <div class="kpi-box__muted">Стабильность хоста</div>
      <div>OpenVPN PID: <span class="kpi-box__value">{{ if .ovpid }}{{ .ovpid }}{{ else }}0{{ end }}</span></div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Процессы</div>
      <div class="kpi-box__value" id="process-count">{{ .sysinfo.Processes }}</div>
      <div class="kpi-box__muted">Ядер CPU: <span id="cpu-count">{{ .sysinfo.CPUCount }}</span></div>
    </div>
  </div>
</div>

<!-- ===== Память / Swap ===== -->
<h5 class="mt-2 mb-2">Память</h5>
<div class="row">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            ОЗУ: <b>{{ printmb .sysinfo.Memory.Used }}</b> / {{ printmb .sysinfo.Memory.Total }} MB — {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-primary progress-bar-striped" style="width: {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            Swap: <b>{{ printmb .sysinfo.Swap.Used }}</b> / {{ printmb .sysinfo.Swap.Total }} MB — {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-secondary progress-bar-striped" style="width: {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%"></div>
          </div>
          {{ if eq .sysinfo.Swap.Total 0 }}
            <div class="small text-warning mt-2">Swap отключён — рекомендовано включить (zram).</div>
          {{ end }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== CPU / Диски ===== -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header d-flex justify-content-between">
        <span>Нагрузка CPU по ядрам</span>
        <span class="small-muted">В процентах</span>
      </div>
      <div class="chart-wrap">
        <canvas id="cpuUsageChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="cpuUsageChart">Нет данных CPU<span class="hint"> (метрика недоступна)</span></div>
      <small class="text-muted d-block mt-2">Доля активного времени (busy %) на ядро.</small>
    </div>
  </div>
  <!-- ===== График: суммарный трафик OpenVPN ===== -->
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">
        Суммарный трафик OpenVPN
        <small class="text-secondary d-block">openvpn_server_bytes_*_total</small>
      </div>
      <div class="chart-wrap">
        <canvas id="serverTotalsChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="serverTotalsChart">Нет данных<span class="hint"> (подключите management/status)</span></div>
      <small class="text-muted d-block mt-2">Источник: management (load-stats) / status.</small>
    </div>
  </div>
</div>

  <div class="row">
    <div class="col-md-12">
      <div class="metric-card">
        <div class="metric-card__header d-flex justify-content-between">
          <span>Использование файловых систем</span>
        <span class="small-muted">Заполненность</span>
      </div>
      <div class="chart-wrap">
        <canvas id="fsUsageChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="fsUsageChart">Нет данных по дискам<span class="hint"> (мониторинг отключен)</span></div>
      <small class="text-muted d-block mt-2">Процент использования по точкам монтирования.</small>
    </div>
  </div>
</div>

<!-- ===== Сеть ===== -->
<h5 class="mt-3 mb-2">Сеть</h5>

<!-- KPI-плашки -->
<div class="row">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">TCP сокеты</div>
      <div class="kpi-box__value" id="kpi-tcp-inuse">—</div>
      <div class="kpi-box__muted">inuse / tw / orphan</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">UDP сокеты</div>
      <div class="kpi-box__value" id="kpi-udp-inuse">—</div>
      <div class="kpi-box__muted">inuse, mem (pages)</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Conntrack</div>
      <div class="kpi-box__value" id="kpi-ct-used">—</div>
      <div class="kpi-box__muted">count / max</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">TCP состояния</div>
      <div class="kpi-box__value" id="kpi-tcp-total">—</div>
      <div class="kpi-box__muted">total sockets</div>
    </div>
  </div>
</div>

<!-- Ряд 1: conntrack + TCP states -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Conntrack usage</div>
      <div class="chart-wrap"><canvas id="ctUsageChart"></canvas></div>
      <div class="empty-state" data-empty-for="ctUsageChart">Нет данных conntrack</div>
      <small class="text-muted d-block mt-2">Использование пула conntrack: Used/Free (%).</small>
    </div>
  </div>
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">TCP состояния</div>
      <div class="chart-wrap"><canvas id="tcpStatesChart"></canvas></div>
      <div class="empty-state" data-empty-for="tcpStatesChart">Нет данных TCP</div>
      <small class="text-muted d-block mt-2">Распределение состояний TCP (listen, established, time_wait, ...).</small>
    </div>
  </div>
</div>

<!-- Ряд 2: интерфейсы + softnet -->
<div class="row">
  <div class="col-lg-8 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Интерфейсы: RX/TX (MB)</div>
      <div class="chart-wrap"><canvas id="ifRxTxChart"></canvas></div>
      <div class="empty-state" data-empty-for="ifRxTxChart">Нет данных по интерфейсам</div>
      <small class="text-muted d-block mt-2">eth*/en*/tun*/tap*/wg*.</small>
    </div>
  </div>
  <div class="col-lg-4 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header d-flex justify-content-between">
        <span>Softnet per-CPU</span>
        <span class="small-muted">dropped / time_squeezed</span>
      </div>
      <div class="chart-wrap"><canvas id="softnetChart"></canvas></div>
      <div class="empty-state" data-empty-for="softnetChart">Нет данных softnet</div>
    </div>
  </div>
</div>

<!-- Ряд 3: TCP/UDP топ портов по очередям -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">TCP: топ портов по RX/TX-очередям</div>
      <div class="chart-wrap"><canvas id="tcpTopPortsChart"></canvas></div>
      <div class="empty-state" data-empty-for="tcpTopPortsChart">Нет данных TCP портов</div>
      <small class="text-muted d-block mt-2">По сумме RX+TX queue (из /proc/net/tcp*). Показано до {{ .TopN }} топ-портов.</small>
    </div>
  </div>
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">UDP: топ портов по RX/TX-очередям</div>
      <div class="chart-wrap"><canvas id="udpTopPortsChart"></canvas></div>
      <div class="empty-state" data-empty-for="udpTopPortsChart">Нет данных UDP портов</div>
      <small class="text-muted d-block mt-2">Суммарные очереди и drop (если есть в /proc/net/udp*).</small>
    </div>
  </div>
</div>

<!-- Таблица: сводные сетевые показатели -->
<div class="card-clean mt-2">
  <div class="card-header">
    <h3 class="card-title" style="margin:0">Сетевые показатели (снимок)</h3>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm" id="net-kpis-table">
        <thead>
          <tr>
            <th>Категория</th>
            <th>Показатель</th>
            <th>Значение</th>
            <th>Комментарий</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="net-warnings" class="small-muted mt-2"></div>
  </div>
</div>

<!-- ===== Таблица клиентов ===== -->
<div class="row mt-3">
  <div class="col-md-12">
    <div class="card-clean">
      <div class="card-header"><h3 class="card-title" style="margin:0">Подключённые клиенты</h3></div>
      <div class="card-body">
        {{if .ovstatus}}
          {{if gt (len .ovstatus.ClientList) 0}}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>CN</th><th>Реальный адрес</th><th>Вирт. адрес</th>
                    <th class="text-right">KB вход</th><th class="text-right">KB выход</th>
                    <th>Сессия с</th><th>Пользователь</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  {{range .ovstatus.ClientList}}
                  <tr>
                    <td>{{.CommonName}}</td>
                    <td>{{.RealAddress}}</td>
                    <td>
                      <span class="badge bg-success">{{.VirtualAddress}}</span>
                      <button class="button-transparent button-copy" data-clipboard-text="{{.VirtualAddress}}">
                        <img class="clippy" src="static/img/clippy.svg" width="13" alt="Copy">
                      </button>
                    </td>
                    <td class="text-right">{{printkb .BytesReceived}}</td>
                    <td class="text-right">{{printkb .BytesSent}}</td>
                    <td>{{.ConnectedSince}}</td>
                    <td>{{if eq .Username "UNDEF"}}-{{else}}{{.Username}}{{end}}</td>
                    <td><a href="javascript:$.MyAPP.Disconnect('{{.CommonName}}')" class="btn btn-xs btn-danger" title="Отключить">Откл.</a></td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
          {{else}}
            <div class="empty-state" style="display:flex; height:140px">Клиентов нет<span class="hint"> (активных сессий не обнаружено)</span></div>
          {{end}}
        {{else}}
          <div class="empty-state" style="display:flex; height:140px">Нет данных статуса<span class="hint"> (проверьте management/status)</span></div>
        {{end}}
      </div>
    </div>
  </div>
</div>

<!-- ===== Версия / ОС ===== -->
<div class="row mt-3">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body d-flex align-items-center">
        <img src="/static/img/openvpn-win.svg" alt="OpenVPN" width="40" height="40" style="opacity:.7; margin-right:12px">
        <div>
          <div class="kpi-box__title">Версия OpenVPN</div>
          <!-- Важно: печатаем .ovversion целиком, чтобы не падать на interface{} -->
          <div class="kpi-box__value" style="font-size:1.2rem">{{ .ovversion }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="kpi-box__title">Операционная система</div>
        <div class="kpi-box__value" style="font-size:1.2rem">{{ .sysinfo.Os }}</div>
        <div class="kpi-box__muted">Архитектура: {{ .sysinfo.Arch }}</div>
        <div class="kpi-box__muted">Хост: <span id="host-name">{{ .sysinfo.Hostname }}</span></div>
        <div class="kpi-box__muted">Загружен: <span id="boot-time">{{ .sysinfo.BootTime }}</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Отладка системных метрик ===== -->
<div class="card-clean mt-3">
  <div class="card-header"><h3 class="card-title" style="margin:0">Отладка системной информации</h3></div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-4 mb-3">
        <div class="small-muted">Текущее время: <span id="current-time">{{ .sysinfo.CurrentTime }}</span></div>
        <div class="small-muted">Аптайм: <span id="debug-uptime">{{ .sysinfo.UptimeS }}</span></div>
        <div class="small-muted">Процессы: <span id="debug-processes">{{ .sysinfo.Processes }}</span></div>
      </div>
      <div class="col-md-8">
        <pre id="sysinfo-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .sysinfo }}</pre>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-12">
        <div class="small-muted mb-2">Все полученные метрики</div>
        <pre id="metrics-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .metrics }}</pre>
      </div>
    </div>
  </div>
</div>

<!-- ===== Скрипты (без опросов) ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const ovstats     = {{ tojson .ovstats  }} || {};
  const sysinfoData = {{ tojson .sysinfo  }} || {};
  const netinfoData = {{ tojson .netinfo  }} || {};

  const palette = ['#17a2b8', '#28a745', '#6f42c1', '#ffc107', '#e83e8c', '#20c997', '#007bff', '#fd7e14'];
  const CHARTS = {};
  function destroyChart(id){ if (CHARTS[id]) { try { CHARTS[id].destroy(); } catch(e){} delete CHARTS[id]; } }
  function isAllZeroOrEmpty(arr){ return !arr || !arr.length || arr.every(v => v===null || v===undefined || v===0); }
  function renderBarOrEmpty({id, labels, datasets, stacked=false}){
    if (!labels || !labels.length || !datasets || datasets.length===0 || datasets.every(ds => isAllZeroOrEmpty(ds.data))){
      destroyChart(id); showEmpty(id, true); return;
    }
    showEmpty(id, false);
    const ctx = document.getElementById(id); if (!ctx) return;
    destroyChart(id);
    CHARTS[id] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: { responsive:true, maintainAspectRatio:false, animation:false,
        scales:{ x:{ stacked }, y:{ stacked, beginAtZero:true } },
        plugins:{ legend:{ position:'bottom' } } }
    });
  }

  function renderCpuUsage(info){
    const list = (info && info.cpuList && info.cpuList.List) || [];
    const labels = list.map((_, i) => `CPU${i}`);
    const data = list.map(cpu => {
      const total = (cpu?.User||0)+(cpu?.Sys||0)+(cpu?.Nice||0)+(cpu?.Idle||0)+(cpu?.Wait||0)+(cpu?.Irq||0)+(cpu?.SoftIrq||0)+(cpu?.Stolen||0);
      if (!total) return 0;
      const busy = total - (cpu?.Idle||0);
      return Math.round((busy/total)*1000)/10;
    });
    renderBarOrEmpty({ id:'cpuUsageChart', labels, datasets:[{ label:'Загрузка (%)', data, backgroundColor:palette[0] }] });
  }

  function renderFsUsage(info){
    const fsList = (info && info.fs) || [];
    const labelOf = (fs) => fs.mount || fs.Mount || fs.device || fs.Device || 'fs';
    const usedPctOf = (fs) => (fs.usedPercent ?? fs.UsedPercent ?? 0);
    const labels = fsList.map(labelOf);
    const data   = fsList.map(fs => Math.round(usedPctOf(fs)*10)/10);
    renderBarOrEmpty({ id:'fsUsageChart', labels, datasets:[{ label:'Использовано (%)', data, backgroundColor:palette[2] }] });
  }

  function renderServerTotals(stats){
    const inMB  = ((stats && stats.BytesIn)  || 0) / 1024 / 1024;
    const outMB = ((stats && stats.BytesOut) || 0) / 1024 / 1024;
    renderBarOrEmpty({ id:'serverTotalsChart', labels:['Вход','Выход'],
      datasets:[{ label:'MB', data:[inMB,outMB], backgroundColor:[palette[0],palette[1]] }] });
  }

  // Сетевые утилиты
  const CHARTS_NET = {};
  function destroyNetChart(id){ if(CHARTS_NET[id]){ try{CHARTS_NET[id].destroy();}catch(e){} delete CHARTS_NET[id]; } }
  function showEmpty(id, show=true){
    const c = document.getElementById(id);
    const e = document.querySelector(`[data-empty-for="${id}"]`);
    if (c) c.style.display = show ? 'none' : 'block';
    if (e) e.style.display  = show ? 'flex' : 'none';
  }
  const mb = v => Math.round((Number(v||0)/1024/1024)*10)/10;
  const pct = (a,b)=> !b?0:Math.max(0,Math.min(100,(a/b)*100));
  const safe = (o,k,def='—') => (o && o[k]!==undefined && o[k]!==null)? o[k] : def;

  // KPI-плашки
  function renderNetKPI(d){
    const s = d?.SockStat || {};
    const s6 = d?.SockStat6 || {};
    const tcpIn = (s.TCP?.InUse||0) + (s6.TCP?.InUse||0);
    const tcpTw = (s.TCP?.TW||0) + (s6.TCP?.TW||0);
    const tcpOr = (s.TCP?.Orphan||0) + (s6.TCP?.Orphan||0);
    document.getElementById('kpi-tcp-inuse').textContent = `${tcpIn} / ${tcpTw} / ${tcpOr}`;

    const udpIn = (s.UDP?.InUse||0) + (s6.UDP?.InUse||0);
    const udpMem = (s.UDP?.Mem||0) + (s6.UDP?.Mem||0);
    document.getElementById('kpi-udp-inuse').textContent = `${udpIn}, mem=${udpMem}`;

    const ct = d?.Conntrack || {};
    const used = (ct.Count||0), max = (ct.Max||0);
    document.getElementById('kpi-ct-used').textContent = max? `${used} / ${max}` : '—';

    const total = d?.TCPStates?.Total || 0;
    document.getElementById('kpi-tcp-total').textContent = `${total}`;
  }

  // Conntrack usage
  function renderConntrack(d){
    const id='ctUsageChart';
    const ct=d?.Conntrack||{};
    const used=Number(ct.Count||0), max=Number(ct.Max||0);
    if(!max){ showEmpty(id,true); return; }
    const usedPct = Math.round(pct(used,max)*10)/10;
    const freePct = 100-usedPct;
    showEmpty(id,false);
    destroyNetChart(id);
    CHARTS_NET[id] = new Chart(document.getElementById(id),{
      type:'bar',
      data:{labels:['Conntrack'],datasets:[
        {label:'Used %',data:[usedPct]},
        {label:'Free %',data:[freePct]},
      ]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{stacked:true,beginAtZero:true,max:100},y:{stacked:true}},
        plugins:{legend:{position:'bottom'},tooltip:{callbacks:{
          label:(c)=>`${c.dataset.label}: ${c.parsed.x.toFixed(1)}% (${used}/${max})`
        }}}
      }
    });
  }

  // TCP states doughnut
  function renderTCPStates(d){
    const id='tcpStatesChart';
    const st=d?.TCPStates||{};
    const labels=['LISTEN','ESTAB','SYN-SENT','SYN-RECV','FIN-WAIT1','FIN-WAIT2','TIME-WAIT','CLOSE','CLOSE-WAIT','LAST-ACK','CLOSING','NEW-SYN-RECV','UNKNOWN'];
    const keys=['Listen','Established','SynSent','SynRecv','FinWait1','FinWait2','TimeWait','Close','CloseWait','LastAck','Closing','NewSynRecv','Unknown'];
    const vals=keys.map(k=>Number(st[k]||0));
    const allZero=vals.every(v=>v===0);
    if(allZero){ showEmpty(id,true); return; }
    showEmpty(id,false);
    destroyNetChart(id);
    CHARTS_NET[id]=new Chart(document.getElementById(id),{
      type:'doughnut',
      data:{labels,datasets:[{data:vals}]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{position:'bottom'}}}
    });
  }

  // Interfaces RX/TX stacked
  function renderIfaces(d){
    const id='ifRxTxChart';
    const ifs=(d?.Ifaces||[]).filter(x=>['eth','en','tun','tap','wg'].some(p=> (x.Name||x.name||'').startsWith(p)));
    if(!ifs.length){ showEmpty(id,true); return; }
    const get = (x,k)=> x[k] ?? x[k.toLowerCase()];
    const labels=ifs.map(x=>x.Name||x.name);
    const rx=ifs.map(x=>mb(get(x,'RxBytes')));
    const tx=ifs.map(x=>mb(get(x,'TxBytes')));
    const allZero=rx.concat(tx).every(v=>v===0);
    if(allZero){ showEmpty(id,true); return; }
    showEmpty(id,false);
    destroyNetChart(id);
    CHARTS_NET[id]=new Chart(document.getElementById(id),{
      type:'bar',
      data:{labels,datasets:[
        {label:'RX MB',data:rx},
        {label:'TX MB',data:tx},
      ]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  // Softnet per-CPU
  function renderSoftnet(d){
    const id='softnetChart';
    const arr=d?.Softnet?.PerCPU||d?.softnet?.per_cpu||[];
    if(!arr.length){ showEmpty(id,true); return; }
    const labels=arr.map(x=>'CPU'+(x.CPU??x.cpu));
    const dropped=arr.map(x=>Number(x.Dropped??x.dropped||0));
    const tsq=arr.map(x=>Number(x.TimeSqueezed??x.time_squeezed||0));
    const allZero=dropped.concat(tsq).every(v=>v===0);
    if(allZero){ showEmpty(id,true); return; }
    showEmpty(id,false);
    destroyNetChart(id);
    CHARTS_NET[id]=new Chart(document.getElementById(id),{
      type:'bar',
      data:{labels,datasets:[
        {label:'dropped',data:dropped},
        {label:'time_squeezed',data:tsq},
      ]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{stacked:true},y:{stacked:false,beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  // TCP top ports
  function renderTcpTopPorts(d){
    const id='tcpTopPortsChart';
    const ps=d?.TCPSocketStats?.PortStats||[];
    if(!ps.length){ showEmpty(id,true); return; }
    const labels=ps.map(p=>String(p.Port));
    const rx=ps.map(p=>Number(p.RxQueue||0));
    const tx=ps.map(p=>Number(p.TxQueue||0));
    const allZero=rx.concat(tx).every(v=>v===0);
    if(allZero){ showEmpty(id,true); return; }
    showEmpty(id,false);
    destroyNetChart(id);
    CHARTS_NET[id]=new Chart(document.getElementById(id),{
      type:'bar',
      data:{labels,datasets:[
        {label:'RX queue',data:rx},
        {label:'TX queue',data:tx},
      ]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{beginAtZero:true},y:{stacked:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  // UDP top ports
  function renderUdpTopPorts(d){
    const id='udpTopPortsChart';
    const ps=d?.UDPPortStats||[];
    if(!ps.length){ showEmpty(id,true); return; }
    const labels=ps.map(p=>String(p.Port));
    const rx=ps.map(p=>Number(p.RxQueue||0));
    const tx=ps.map(p=>Number(p.TxQueue||0));
    const drops=ps.map(p=>Number(p.Drops||0));
    const allZero=rx.concat(tx).every(v=>v===0) && drops.every(v=>v===0);
    if(allZero){ showEmpty(id,true); return; }
    showEmpty(id,false);
    destroyNetChart(id);
    CHARTS_NET[id]=new Chart(document.getElementById(id),{
      type:'bar',
      data:{labels,datasets:[
        {label:'RX queue',data:rx},
        {label:'TX queue',data:tx},
        {type:'line',label:'drops',data:drops, yAxisID:'y2'}
      ]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{beginAtZero:true}, y:{stacked:true}, y2:{position:'right',beginAtZero:true,grid:{display:false}}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  // Таблица KPI
  function badge(val, dangerIfGtZero=true){
    const v=Number(val||0);
    if (dangerIfGtZero && v>0) return `<span class="badge bg-danger">${v}</span>`;
    return v===0 ? `<span class="badge bg-success">0</span>` : String(v);
  }
  function row(tb,cat,key,val,note){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${cat}</td><td>${key}</td><td>${val}</td><td class="small-muted">${note||''}</td>`;
    tb.appendChild(tr);
  }
  function renderNetKPIs(d){
    const tb=document.querySelector('#net-kpis-table tbody'); if(!tb) return;
    tb.innerHTML='';
    const snmp=d?.SNMP||{};
    const udp=snmp.UDP||{}, udp6=snmp.UDP6||{};
    const te =snmp.TCPExt||{};
    const ct =d?.Conntrack||{};
    const st =d?.Softnet?.Total||{};
    const lim=d?.UDPMemLimits||{};
    const s = d?.SockStat||{}, s6=d?.SockStat6||{};

    // UDP (v4+v6, где применимо)
    row(tb,'UDP','InDatagrams', (udp.InDatagrams??'—'), 'v4');
    row(tb,'UDP','OutDatagrams',(udp.OutDatagrams??'—'),'v4');
    row(tb,'UDP','NoPorts', badge(udp.NoPorts,false), 'v4');
    row(tb,'UDP','InErrors', badge(udp.InErrors), 'v4');
    row(tb,'UDP','RcvbufErrors', badge(udp.RcvbufErrors), 'v4');
    row(tb,'UDP','SndbufErrors', badge(udp.SndbufErrors), 'v4');

    if (Object.keys(udp6).length){
      row(tb,'UDP6','InDatagrams', (udp6.InDatagrams??'—'),'v6');
      row(tb,'UDP6','OutDatagrams',(udp6.OutDatagrams??'—'),'v6');
      if (udp6.NoPorts!==undefined) row(tb,'UDP6','NoPorts', badge(udp6.NoPorts,false),'v6');
      if (udp6.InErrors!==undefined) row(tb,'UDP6','InErrors', badge(udp6.InErrors),'v6');
    }

    // TCP ext
    if (te){
      if (te.ListenOverflows!==undefined) row(tb,'TCP','ListenOverflows', badge(te.ListenOverflows),'переполнение очереди accept');
      if (te.ListenDrops!==undefined)     row(tb,'TCP','ListenDrops',     badge(te.ListenDrops),'скидывали входящие при accept');
      if (te.RetransSegs!==undefined)     row(tb,'TCP','RetransSegs',     te.RetransSegs,'ретрансмит сегментов (накоп.)');
      if (te.TCPTimeouts!==undefined)     row(tb,'TCP','TCPTimeouts',     te.TCPTimeouts,'таймауты RTO');
    }

    // Conntrack
    const used=ct.Count||0, max=ct.Max||0, usedPct = max? Math.round((used/max)*1000)/10 : '—';
    row(tb,'Conntrack','Count', used, 'текущие записи');
    row(tb,'Conntrack','Max',   max, 'лимит');
    if (ct.Buckets!==undefined) row(tb,'Conntrack','Buckets',ct.Buckets,'хэш-ёмкость');
    row(tb,'Conntrack','Used %', (max?usedPct:'—'), 'использование пула');

    // Softnet total
    row(tb,'Softnet','Processed', st.Processed??'—','обработано в софтIRQ');
    row(tb,'Softnet','Dropped', badge(st.Dropped),'потери до сокетов');
    row(tb,'Softnet','TimeSqueezed', st.TimeSqueezed??'—','давление по времени');

    // UDP memory limits
    if ((lim.UDPMem||[]).length===3){
      row(tb,'UDP mem','udp_mem (low/pressure/high)', `${lim.UDPMem[0]} / ${lim.UDPMem[1]} / ${lim.UDPMem[2]}`, 'страницы');
    }
    row(tb,'UDP mem','udp_rmem_min', lim.UDPRMemMin||'—','байт');
    row(tb,'UDP mem','udp_wmem_min', lim.UDPWMemMin||'—','байт');
    row(tb,'Core mem','rmem_default / rmem_max', `${lim.CoreRMemDefault||'—'} / ${lim.CoreRMemMax||'—'}`, 'байт');
    row(tb,'Core mem','wmem_default / wmem_max', `${lim.CoreWMemDefault||'—'} / ${lim.CoreWMemMax||'—'}`, 'байт');

    // Sockstat (суммарно v4+v6)
    const tcpIn=(s.TCP?.InUse||0)+(s6.TCP?.InUse||0);
    const tcpTw=(s.TCP?.TW||0)+(s6.TCP?.TW||0);
    const tcpOr=(s.TCP?.Orphan||0)+(s6.TCP?.Orphan||0);
    row(tb,'Sockstat','TCP inuse / tw / orphan', `${tcpIn} / ${tcpTw} / ${tcpOr}`, '');
    const udpIn=(s.UDP?.InUse||0)+(s6.UDP?.InUse||0);
    row(tb,'Sockstat','UDP inuse', udpIn, '');

    // Интерфейсы (кратко для eth0/tun0 если есть)
    const ifs=d?.Ifaces||[];
    const pick=n=>ifs.find(x=>(x.Name||x.name)===n);
    ['eth0','tun0'].forEach(n=>{
      const it=pick(n); if(!it) return;
      const rx=mb(it.RxBytes??it.rx_bytes), tx=mb(it.TxBytes??it.tx_bytes);
      const errs=(Number(it.RxErrors||0)+Number(it.TxErrors||0));
      const drops=(Number(it.RxDropped||0)+Number(it.TxDropped||0));
      row(tb,`Iface ${n}`,'RX/TX (MB)', `${rx} / ${tx}`,'накоп.');
      row(tb,`Iface ${n}`,'Errors', badge(errs),'RX+TX');
      row(tb,`Iface ${n}`,'Dropped', badge(drops),'RX+TX');
      row(tb,`Iface ${n}`,'Oper/MTU', `${it.OperState||it.operstate||'—'} / ${it.MTU||it.mtu||'—'}`, '');
    });

    // warnings
    const w = d?.Warnings||[];
    const wEl=document.getElementById('net-warnings');
    if (wEl){
      wEl.innerHTML = w.length? ('Предупреждения: ' + w.map(x=>`<span class="badge bg-warning text-dark me-1">${x}</span>`).join(' ')) : '';
    }
  }

  // Единоразовый рендер
  renderCpuUsage(sysinfoData);
  renderFsUsage(sysinfoData);
  renderServerTotals(ovstats);

  // Сетевой раздел (снимок)
  renderNetKPI(netinfoData);
  renderConntrack(netinfoData);
  renderTCPStates(netinfoData);
  renderIfaces(netinfoData);
  renderSoftnet(netinfoData);
  renderTcpTopPorts(netinfoData);
  renderUdpTopPorts(netinfoData);
  renderNetKPIs(netinfoData);

  // Копирование адресов (иконка-скрепка)
  (function(){
    const btns = document.querySelectorAll('.button-copy');
    btns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const txt = b.getAttribute('data-clipboard-text') || '';
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(()=> {
          const icon = b.querySelector('.clippy'); if (!icon) return;
          icon.style.opacity = 1; setTimeout(()=>{ icon.style.opacity = .6; }, 800);
        });
      });
    });
  })();
</script>

{{end}}
