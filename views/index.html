{{ template "layout/base.html" . }}

{{define "head"}}
<title>NiceSOFT NiceVPN UI — Сводка</title>
<style>
  :root{--bg:#f8f9fa; --card:#fff; --muted:#6c757d; --border:#e9ecef; --shadow:0 3px 10px rgba(0,0,0,.05)}
  @media (prefers-color-scheme: dark){
    :root{--bg:#0f1115; --card:#171a1f; --muted:#a8b2c1; --border:#2a2e35; --shadow:0 4px 14px rgba(0,0,0,.45); color-scheme:dark}
  }
  .force-dark{--bg:#0f1115; --card:#171a1f; --muted:#a8b2c1; --border:#2a2e35; --shadow:0 4px 14px rgba(0,0,0,.45); color-scheme:dark; background:var(--bg) !important; color:#e6e8eb !important}
  body{background:var(--bg)}
  /* ===== Корпоративный нейтральный стиль ===== */
  .kpi-box{border-radius:14px; box-shadow:var(--shadow); padding:16px; background:var(--card); height:100%; border:1px solid var(--border)}
  .kpi-box__title{font-size:.9rem; color:var(--muted); margin-bottom:.25rem}
  .kpi-box__value{font-size:1.6rem; font-weight:700; line-height:1.1}
  .kpi-box__muted{color:var(--muted); font-size:.9rem}
  .card-clean{border:1px solid var(--border); border-radius:14px; background:var(--card); box-shadow:var(--shadow)}
  .card-clean .card-header{border-bottom:1px solid var(--border); background:var(--card); border-top-left-radius:14px; border-top-right-radius:14px}
  .card-clean .card-body{padding:16px}
  .metric-card{border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.03); background:var(--card)}
  .metric-card__header{font-weight:600; margin-bottom:8px}
  .metric-card .chart-wrap{position:relative; height:220px}
  .metric-card canvas{width:100% !important; height:100% !important}
  .status-pill{display:inline-flex; align-items:center; padding:5px 12px; border-radius:999px; font-weight:700; font-size:.9rem; color:#fff; letter-spacing:.03em; text-transform:uppercase}
  .pill-ok{background:#28a745}
  .pill-warn{background:#ffc107; color:#212529}
  .pill-bad{background:#dc3545}
  .small-muted{font-size:.85rem; color:var(--muted)}
  .empty-state{display:none; align-items:center; justify-content:center; height:220px; border:2px dashed var(--border); border-radius:10px; color:var(--muted); font-size:.95rem; background:var(--bg)}
  .empty-state .hint{font-size:.85rem; color:#9aa0a6; margin-left:.5rem}
  .progress-xs{height:10px}
  .progress-number{font-weight:600}
  .table thead th{white-space:nowrap}
  .button-transparent{background:transparent;border:0;padding:0;margin-left:6px}
  .clippy{opacity:.6}
  .clippy:hover{opacity:1}
  .theme-toggle{position:fixed; right:16px; bottom:16px; z-index:999; border-radius:999px; box-shadow:var(--shadow);}
  .fw-nav{gap:8px; flex-wrap:wrap}
  .fw-nav a{padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--card); box-shadow:var(--shadow); color:inherit; text-decoration:none; font-weight:600;}
  .fw-section{scroll-margin-top:80px;}
  .pill-muted{background:#6c757d; color:#fff}
  .mono{font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace}
</style>
{{end}}

{{define "body"}}
<div class="row">
  <div class="col-xl-2 col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Подключённые клиенты</div>
      <div class="kpi-box__value">{{ if .ovstats }}{{ .ovstats.NClients }}{{ else }}0{{ end }}</div>
      <div class="kpi-box__muted">
        Вход: {{ if .ovstats }}{{ printmb .ovstats.BytesIn }}{{ else }}0{{ end }} MB •
        Выход: {{ if .ovstats }}{{ printmb .ovstats.BytesOut }}{{ else }}0{{ end }} MB
      </div>
    </div>
  </div>

  <div class="col-xl-2 col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Нагрузка (Load Average)</div>
      <div class="kpi-box__value">1м: {{ .sysinfo.LoadAvg.One }}</div>
      <div class="kpi-box__muted">5м: {{ .sysinfo.LoadAvg.Five }} • 15м: {{ .sysinfo.LoadAvg.Fifteen }}</div>
    </div>
  </div>

  <div class="col-xl-2 col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Аптайм ОС</div>
      <div class="kpi-box__value">{{ .sysinfo.UptimeS }}</div>
      <div class="kpi-box__muted">Стабильность хоста</div>
      <div>OpenVPN PID: <span class="kpi-box__value">{{ if .ovpid }}{{ .ovpid }}{{ else }}0{{ end }}</span></div>
    </div>
  </div>

  <div class="col-xl-2 col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Процессы</div>
      <div class="kpi-box__value" id="process-count">{{ .sysinfo.Processes }}</div>
      <div class="kpi-box__muted">Ядер CPU: <span id="cpu-count">{{ .sysinfo.CPUCount }}</span></div>
    </div>
  </div>

  <div class="col-xl-2 col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Эффективность VPN</div>
       <!-- data-* заполняем в JS -->
      <div
        class="kpi-box__value"
        id="kpi-vpn-eff"
        data-ov-in=""
        data-ov-out=""
        data-tun-rx="" data-tun-tx="" data-eth-rx="" data-eth-tx="">—</div>
      <div class="kpi-box__muted">Асимметрия: <span id="kpi-vpn-asym">—</span></div>
    </div>
  </div>

  <div class="col-xl-2 col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Шифр активных сессий</div>
      {{ $cipher := "" }}
      {{ if and .ovstatus (gt (len .ovstatus.ClientList) 0) }}{{ $cipher = (index .ovstatus.ClientList 0).DataCipher }}{{ end }}
      <div class="kpi-box__value" id="kpi-active-cipher">{{ if $cipher }}{{ $cipher }}{{ else }}—{{ end }}</div>
      <div class="kpi-box__muted" id="kpi-active-cipher-badges"></div>
    </div>
  </div>
</div>

<!-- ===== Память / Swap ===== -->
<h5 class="mt-2 mb-2">Память</h5>
<div class="row">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            ОЗУ: <b>{{ printmb .sysinfo.Memory.Used }}</b> / {{ printmb .sysinfo.Memory.Total }} MB — {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-primary progress-bar-striped" role="progressbar" aria-valuenow="{{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}" aria-valuemin="0" aria-valuemax="100" style="width: {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            Swap: <b>{{ printmb .sysinfo.Swap.Used }}</b> / {{ printmb .sysinfo.Swap.Total }} MB — {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-secondary progress-bar-striped" role="progressbar" aria-valuenow="{{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}" aria-valuemin="0" aria-valuemax="100" style="width: {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%"></div>
          </div>
          {{ if eq .sysinfo.Swap.Total 0 }}
            <div class="small text-warning mt-2">Swap отключён — рекомендовано включить (zram).</div>
          {{ end }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== CPU / Диски ===== -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header d-flex justify-content-between">
        <span>Нагрузка CPU по ядрам</span>
        <span class="small-muted">В процентах</span>
      </div>
      <div class="chart-wrap">
        <canvas id="cpuUsageChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="cpuUsageChart">Нет данных CPU<span class="hint"> (метрика недоступна)</span></div>
      <small class="text-muted d-block mt-2">Доля активного времени (busy %) на ядро.</small>
    </div>
  </div>
  <!-- ===== График: суммарный трафик OpenVPN ===== -->
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">
        Суммарный трафик OpenVPN
        <small class="text-secondary d-block">openvpn_server_bytes_*_total</small>
      </div>
      <div class="chart-wrap">
        <canvas id="serverTotalsChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="serverTotalsChart">Нет данных<span class="hint"> (подключите management/status)</span></div>
      <small class="text-muted d-block mt-2">Источник: management (load-stats) / status.</small>
    </div>
  </div>
</div>

  <div class="row">
    <div class="col-md-12">
      <div class="metric-card">
        <div class="metric-card__header d-flex justify-content-between">
          <span>Использование файловых систем</span>
        <span class="small-muted">Заполненность</span>
      </div>
      <div class="chart-wrap">
        <canvas id="fsUsageChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="fsUsageChart">Нет данных по дискам<span class="hint"> (мониторинг отключен)</span></div>
      <small class="text-muted d-block mt-2">Процент использования по точкам монтирования.</small>
    </div>
  </div>
</div>

<!-- Алёрт о деградации сети создаём/заполняем в JS -->
<div id="net-degradation-alert" class="alert alert-danger" style="display:none"></div>

<h5 class="mt-3 mb-2">Сеть</h5>

<!-- KPI по сети -->
<div class="row">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">TCP сокеты</div>
      <div class="kpi-box__value" id="kpi-tcp-inuse">—</div>
      <div class="kpi-box__muted">inuse / tw / orphan</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">UDP сокеты</div>
      <div class="kpi-box__value" id="kpi-udp-inuse">—</div>
      <div class="kpi-box__muted">inuse, mem (pages)</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Conntrack</div>
      <div class="kpi-box__value" id="kpi-ct-used">—</div>
      <div class="kpi-box__muted">count / max</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">TCP состояния</div>
      <div class="kpi-box__value" id="kpi-tcp-total">—</div>
      <div class="kpi-box__muted">total sockets</div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Conntrack usage -->
  <div class="col-lg-4 col-md-6 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Conntrack usage</div>
      <div class="chart-wrap"><canvas id="conntrackGauge"></canvas></div>
      <div class="empty-state" data-empty-for="conntrackGauge">Нет данных conntrack</div>
    </div>
  </div>

  <!-- Softnet per-CPU -->
  <div class="col-lg-8 col-md-6 mb-4">
    <div class="metric-card">
      <div class="metric-card__header d-flex justify-content-between">
        <span>Softnet per-CPU</span>
        <span class="small-muted">dropped / time_squeezed</span>
      </div>
      <div class="chart-wrap"><canvas id="softnetChart"></canvas></div>
      <div class="empty-state" data-empty-for="softnetChart">Нет данных softnet</div>
    </div>
  </div>
</div>

<div class="row">
  <!-- TCP States -->
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">TCP состояния</div>
      <div class="chart-wrap"><canvas id="tcpStatesChart"></canvas></div>
      <div class="empty-state" data-empty-for="tcpStatesChart">Нет данных TCP</div>
    </div>
  </div>

  <!-- TCP топ портов -->
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">TCP: топ портов по RX/TX-очередям</div>
      <div class="chart-wrap"><canvas id="tcpTopPortsChart"></canvas></div>
      <div class="empty-state" data-empty-for="tcpTopPortsChart">Нет данных TCP портов</div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Interfaces RX/TX -->
  <div class="col-lg-8 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Интерфейсы: RX/TX (MB)</div>
      <div class="chart-wrap"><canvas id="ifaceRxTxChart"></canvas></div>
      <div class="empty-state" data-empty-for="ifaceRxTxChart">Нет данных по интерфейсам</div>
      <small class="text-muted d-block mt-2">Показывает объёмы RX/TX по интерфейсам eth*/en*/tun*/tap*/wg*.</small>
    </div>
  </div>

  <!-- UDP Health -->
  <div class="col-lg-4 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">UDP Health</div>
      <div class="chart-wrap"><canvas id="udpHealthChart"></canvas></div>
      <div class="empty-state" data-empty-for="udpHealthChart">Нет данных UDP</div>
      <small class="text-muted d-block mt-2">Ключевые счётчики: In/OutDatagrams, NoPorts, InErrors, Rcvbuf/SndbufErrors, IgnoredMulti.</small>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-12 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">UDP: топ портов по RX/TX-очередям</div>
      <div class="chart-wrap"><canvas id="udpTopPortsChart"></canvas></div>
      <div class="empty-state" data-empty-for="udpTopPortsChart">Нет данных UDP портов</div>
    </div>
  </div>
</div>

<!-- Таблица: ключевые сетевые показатели -->
<div class="card-clean mt-2">
  <div class="card-header">
    <h3 class="card-title" style="margin:0">Сетевые показатели (снимок)</h3>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm" id="net-kpis-table">
        <thead>
          <tr>
            <th>Категория</th>
            <th>Показатель</th>
            <th>Значение</th>
            <th>Комментарий</th>
          </tr>
        </thead>
        <tbody>
          <!-- Заполняется JS: renderNetKPIs(netinfoData) -->
        </tbody>
      </table>
    </div>
    <div id="net-warnings" class="mt-2"></div>
  </div>
</div>

<h5 class="mt-4 mb-2">Firewall</h5>
<div class="d-flex fw-nav mb-3">
  <a href="#fw-overview">Firewall</a>
  <a href="#fw-chains">Chains</a>
  <a href="#fw-rules">Rules</a>
  <a href="#fw-ports">Ports</a>
  <a href="#fw-nat">NAT</a>
  <a href="#fw-docker">Docker</a>
  <a href="#fw-ipv6">IPv6</a>
  <a href="#fw-diagnostics">Diagnostics</a>
</div>

<!-- ===== Firewall Overview ===== -->
<div id="fw-overview" class="fw-section">
  <div class="card-clean mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h3 class="card-title mb-0">Firewall — Overview</h3>
      <span class="small text-muted">nftables snapshot</span>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3"><div class="kpi-box"><div class="kpi-box__title">Всего пакетов</div><div class="kpi-box__value mono" id="fw-kpi-total-packets">—</div></div></div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3"><div class="kpi-box"><div class="kpi-box__title">Всего байтов</div><div class="kpi-box__value mono" id="fw-kpi-total-bytes">—</div></div></div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3"><div class="kpi-box"><div class="kpi-box__title">Verdicts (pkt)</div><div class="kpi-box__value" id="fw-kpi-verdicts">—</div></div></div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3"><div class="kpi-box"><div class="kpi-box__title">Chains / Rules</div><div class="kpi-box__value" id="fw-kpi-chains-rules">—</div></div></div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3"><div class="kpi-box"><div class="kpi-box__title">Forward policy</div><div class="kpi-box__value" id="fw-kpi-forward-policy">—</div></div></div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3"><div class="kpi-box"><div class="kpi-box__title">Default route</div><div class="kpi-box__value" id="fw-kpi-default-route">—</div></div></div>
      </div>

      <div class="row">
        <div class="col-lg-4 col-md-6 mb-3">
          <div class="metric-card">
            <div class="metric-card__header d-flex justify-content-between align-items-center">Verdict distribution <span class="small-muted" id="fw-metric-toggle" data-metric="packets">packets</span></div>
            <div class="chart-wrap"><canvas id="fw-verdict-donut"></canvas></div>
            <div class="empty-state" data-empty-for="fw-verdict-donut">Нет данных verdicts</div>
            <div class="mt-2 small-muted">По байтам: <span id="fw-verdict-bytes-mini">—</span></div>
          </div>
        </div>
        <div class="col-lg-8 col-md-6 mb-3">
          <div class="metric-card">
            <div class="metric-card__header d-flex justify-content-between align-items-center">Top chains <button class="btn btn-xs btn-outline-secondary" id="fw-top-metric">packets</button></div>
            <div class="chart-wrap"><canvas id="fw-top-chains"></canvas></div>
            <div class="empty-state" data-empty-for="fw-top-chains">Нет данных по цепочкам</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Chains ===== -->
<div id="fw-chains" class="fw-section card-clean mb-3">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-between"><h3 class="card-title mb-0">Chains summary</h3></div>
  <div class="card-body">
    <div class="row mb-2">
      <div class="col-md-3 mb-2"><label class="small text-muted">Family</label><select class="form-control form-control-sm" id="fw-filter-family"><option value="both">both</option><option value="ip">ip</option><option value="ip6">ip6</option></select></div>
      <div class="col-md-3 mb-2"><label class="small text-muted">Hook</label><select class="form-control form-control-sm" id="fw-filter-hook"><option value="all">все</option><option value="0">PREROUTING</option><option value="1">INPUT</option><option value="2">FORWARD</option><option value="3">OUTPUT</option><option value="4">POSTROUTING</option></select></div>
      <div class="col-md-3 mb-2"><label class="small text-muted">Policy</label><select class="form-control form-control-sm" id="fw-filter-policy"><option value="any">any</option><option value="ACCEPT">ACCEPT</option><option value="DROP">DROP</option><option value="none">—</option></select></div>
      <div class="col-md-3 mb-2"><label class="small text-muted">Packets &gt;=</label><input type="number" class="form-control form-control-sm" id="fw-filter-packets" placeholder="0"></div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm" id="fw-chains-table">
        <thead><tr><th>Family</th><th>Table / Chain</th><th>Hook</th><th>Policy</th><th>Packets</th><th>Bytes</th><th>Rules</th><th>Подробнее</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="fw-chain-detail" class="mt-3"></div>
  </div>
</div>

<!-- ===== Rules Explorer ===== -->
<div id="fw-rules" class="fw-section card-clean mb-3">
  <div class="card-header"><h3 class="card-title mb-0">Rules Explorer</h3></div>
  <div class="card-body">
    <div class="row mb-2">
      <div class="col-md-6 mb-2"><input type="search" class="form-control" id="fw-rules-search" placeholder="Поиск по Expr/Matches"></div>
      <div class="col-md-6 mb-2"><select class="form-control" id="fw-rules-preset"><option value="">— быстрый фильтр —</option><option value="INPUT-dpt">INPUT &amp; dpt=*</option><option value="DOCKER">DOCKER-*</option><option value="ip-nat">ip/nat (PREROUTING/POSTROUTING)</option><option value="ipv6">IPv6 only</option><option value="DROP">DROP only</option></select></div>
    </div>
    <div class="table-responsive" style="max-height:420px; overflow:auto">
      <table class="table table-sm" id="fw-rules-table">
        <thead><tr><th>Family</th><th>Table</th><th>Chain</th><th>Index</th><th>Expr</th><th>Matches</th><th>Verdict</th><th>Packets</th><th>Bytes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== Ports ===== -->
<div id="fw-ports" class="fw-section card-clean mb-3">
  <div class="card-header"><h3 class="card-title mb-0">Ports (IPv4/INPUT)</h3></div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm" id="fw-ports-input-table"><thead><tr><th>Port</th><th>Proto</th><th>Packets</th><th>Bytes</th><th>Rules</th><th>Traffic</th><th>Jump path</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- ===== NAT ===== -->
<div id="fw-nat" class="fw-section card-clean mb-3">
  <div class="card-header"><h3 class="card-title mb-0">NAT</h3></div>
  <div class="card-body">
    <div id="fw-nat-cards" class="row mb-3"></div>
    <div class="table-responsive">
      <table class="table table-sm" id="fw-nat-table"><thead><tr><th>Chain</th><th>Index</th><th>Expr</th><th>Verdict</th><th>Packets</th><th>Bytes</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- ===== Docker ===== -->
<div id="fw-docker" class="fw-section card-clean mb-3">
  <div class="card-header"><h3 class="card-title mb-0">Docker</h3></div>
  <div class="card-body">
    <div id="fw-docker-flow" class="mb-3"></div>
    <div class="table-responsive">
      <table class="table table-sm" id="fw-docker-table"><thead><tr><th>Chain</th><th>Packets</th><th>Bytes</th><th>Rules</th><th>Notes</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- ===== IPv6 ===== -->
<div id="fw-ipv6" class="fw-section card-clean mb-3">
  <div class="card-header"><h3 class="card-title mb-0">IPv6</h3></div>
  <div class="card-body">
    <div id="fw-ipv6-cards" class="row mb-3"></div>
    <div class="metric-card"><div class="chart-wrap"><canvas id="fw-ipv6-verdict-donut"></canvas></div><div class="empty-state" data-empty-for="fw-ipv6-verdict-donut">Нет данных IPv6</div></div>
  </div>
</div>

<!-- ===== Diagnostics ===== -->
<div id="fw-diagnostics" class="fw-section card-clean mb-4">
  <div class="card-header"><h3 class="card-title mb-0">Diagnostics</h3></div>
  <div class="card-body">
    <div id="fw-alerts" class="mb-3"></div>
    <div class="table-responsive">
      <table class="table table-sm" id="fw-policy-matrix"><thead><tr><th>Hook</th><th>IPv4</th><th>IPv6</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- ===== Таблица клиентов ===== -->
<div class="row mt-3">
  <div class="col-md-12">
    <div class="card-clean">
      <div class="card-header"><h3 class="card-title" style="margin:0">Подключённые клиенты</h3></div>
      <div class="card-body">
        {{if .ovstatus}}
          {{if gt (len .ovstatus.ClientList) 0}}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>CN</th><th>Реальный адрес</th><th>Вирт. адрес</th>
                    <th class="text-right">KB вход</th><th class="text-right">KB выход</th>
                    <th>Сессия с</th><th>Пользователь</th><th>Активность</th><th>Шифр</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  {{range .ovstatus.ClientList}}
                  <tr>
                    <td>{{.CommonName}}</td>
                    <td>{{.RealAddress}}</td>
                    <td>
                      <span class="badge bg-success">{{.VirtualAddress}}</span>
                      <button class="button-transparent button-copy" data-clipboard-text="{{.VirtualAddress}}">
                        <img class="clippy" src="static/img/clippy.svg" width="13" alt="Copy">
                      </button>
                    </td>
                    <td class="text-right">{{printkb .BytesReceived}}</td>
                    <td class="text-right">{{printkb .BytesSent}}</td>
                    <td>{{.ConnectedSince}}</td>
                    <td>{{if eq .Username "UNDEF"}}-{{else}}{{.Username}}{{end}}</td>
                    {{ $last := "" }}{{ $cn := .CommonName }}
                    {{ range $.ovstatus.RoutingTable }}
                      {{ if eq .CommonName $cn }}{{ $last = .LastRef }}{{ end }}
                    {{ end }}
                    <td>{{ if $last }}{{ $last }}{{ else }}—{{ end }}</td>
                    {{ $cipher := .DataCipher }}
                    <td data-cipher="{{$cipher}}"><span class="badge bg-info text-dark">{{$cipher}}</span></td>
                    <td><a href="javascript:$.MyAPP.Disconnect('{{.CommonName}}')" class="btn btn-xs btn-danger" title="Отключить">Откл.</a></td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
          {{else}}
            <div class="empty-state" style="display:flex; height:140px">Клиентов нет<span class="hint"> (активных сессий не обнаружено)</span></div>
          {{end}}
        {{else}}
          <div class="empty-state" style="display:flex; height:140px">Нет данных статуса<span class="hint"> (проверьте management/status)</span></div>
        {{end}}
      </div>
    </div>
  </div>
</div>

<!-- ===== Версия / ОС ===== -->
<div class="row mt-3">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body d-flex align-items-center">
        <img src="/static/img/openvpn-win.svg" alt="OpenVPN" width="40" height="40" style="opacity:.7; margin-right:12px">
        <div>
          <div class="kpi-box__title">Версия OpenVPN</div>
          <!-- Важно: печатаем .ovversion целиком, чтобы не падать на interface{} -->
          <div class="kpi-box__value" style="font-size:1.2rem">{{ .ovversion }}</div>
          <div id="dco-badge" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="kpi-box__title">Операционная система</div>
        <div class="kpi-box__value" style="font-size:1.2rem">{{ .sysinfo.Os }}</div>
        <div class="kpi-box__muted">Архитектура: {{ .sysinfo.Arch }}</div>
        <div class="kpi-box__muted">Хост: <span id="host-name">{{ .sysinfo.Hostname }}</span></div>
        <div class="kpi-box__muted">Загружен: <span id="boot-time">{{ .sysinfo.BootTime }}</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Отладка системных метрик ===== -->
<div class="card-clean mt-3">
  <div class="card-header"><h3 class="card-title" style="margin:0">Отладка системной информации</h3></div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-4 mb-3">
        <div class="small-muted">Текущее время: <span id="current-time">{{ .sysinfo.CurrentTime }}</span></div>
        <div class="small-muted">Аптайм: <span id="debug-uptime">{{ .sysinfo.UptimeS }}</span></div>
        <div class="small-muted">Процессы: <span id="debug-processes">{{ .sysinfo.Processes }}</span></div>
      </div>
      <div class="col-md-8">
        <pre id="sysinfo-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .sysinfo }}</pre>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-12">
        <div class="small-muted mb-2">Все полученные метрики</div>
        <pre id="metrics-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .metrics }}</pre>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-12">
        <div class="small-muted mb-2">Метрики файрвола (nftables)</div>
        <pre id="firewall-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .firewall }}</pre>
      </div>
    </div>
  </div>
</div>

<button type="button" class="btn btn-light theme-toggle" id="theme-toggle">Тема</button>

<!-- ===== Скрипты (без опросов) ===== -->
<script src="/static/js/chart.umd.min.js"></script>
<script>
  const ovstats     = {{ tojson .ovstats  }} || {};
  const ovstatus    = {{ tojson .ovstatus }} || {};
  const sysinfoData = {{ tojson .sysinfo  }} || {};
  const netinfoData = {{ tojson .netinfo  }} || {};
  const fw          = {{ tojson .firewall }} || {};

  const palette = ['#17a2b8', '#28a745', '#6f42c1', '#ffc107', '#e83e8c', '#20c997'];
  const CHARTS = {};
  function showEmpty(id, show=true){
    const canvas = document.getElementById(id);
    const empty = document.querySelector(`[data-empty-for="${id}"]`);
    if (canvas) canvas.style.display = show ? 'none' : 'block';
    if (empty)  empty.style.display  = show ? 'flex' : 'none';
  }
  function upsertChart(store, id, makeConfig){
    const ctx = document.getElementById(id); if(!ctx) return null;
    const cfg = makeConfig();
    if (store[id]) { store[id].data = cfg.data; store[id].options = cfg.options||store[id].options; store[id].update(); return store[id]; }
    store[id] = new Chart(ctx, cfg); return store[id];
  }
  function isAllZeroOrEmpty(arr){ return !arr || !arr.length || arr.every(v => v===null || v===undefined || v===0); }
  function lazyChart(id, renderFn){
    const el = document.getElementById(id); if(!el) return;
    const io = new IntersectionObserver(es=>{
      es.forEach(e=>{ if(e.isIntersecting){ renderFn(); io.disconnect(); } });
    }, {root:null, rootMargin:'200px', threshold:.01});
    io.observe(el);
  }
  function safeTd(text){ const td=document.createElement('td'); td.textContent=String(text??''); return td; }
  function addRow(tb, cells){ const tr=document.createElement('tr'); cells.forEach(c=>tr.appendChild(c instanceof Node? c : safeTd(c))); tb.appendChild(tr); }
  const mb = (x)=> Math.round((Number(x||0)/1024/1024)*10)/10;
  const percent = (part,total)=>{ if (!total) return 0; return Math.max(0, Math.min(100, (part/total)*100)); };
  const makeNote = (text)=>{ const td=safeTd(text); td.classList.add('small-muted'); return td; };
  const makeBadge = (val, dangerIfGtZero=true)=>{ const span=document.createElement('span'); const num=Number(val||0); span.className=(dangerIfGtZero && num>0)?'badge bg-danger':'badge bg-success'; span.textContent=String(num); if(!dangerIfGtZero && num!==0){ span.className='badge bg-secondary'; } return span; };
  const makeBadgeCell = (val, dangerIfGtZero=true)=>{ const td=document.createElement('td'); td.appendChild(makeBadge(val, dangerIfGtZero)); return td; };
  // -------- Универсальные извлекатели из netinfo (структура или map) --------
  function first(a, b){ return a!==undefined ? a : b; }
  function toNum(x){ const n=Number(x||0); return Number.isFinite(n)? n : 0; }
  function fmtPackets(v){ const n=Number(v||0); if (n>=1e6) return `${(n/1e6).toFixed(1)}M`; if (n>=1e3) return `${(n/1e3).toFixed(1)}K`; return String(n); }
  function fmtBytes(v){ const n=Number(v||0); const kb=1024, mb=kb*1024, gb=mb*1024; if (n>=gb) return `${(n/gb).toFixed(1)} GB`; if (n>=mb) return `${(n/mb).toFixed(1)} MB`; if (n>=kb) return `${(n/kb).toFixed(1)} KB`; return `${n} B`; }
  function verdictColor(v){ switch((v||'').toUpperCase()){ case 'ACCEPT': return '#28a745'; case 'DROP': return '#dc3545'; case 'JUMP': return '#0d6efd'; case 'RETURN': return '#6f42c1'; default: return '#6c757d'; } }

  function extractIfaceBytes(net){
    // ожидаем либо net.ifaces = [{name, rx_bytes, tx_bytes}, ...]
    const ifs = Array.isArray(net?.ifaces) ? net.ifaces : [];
    const pick = (name) => {
      const it = ifs.find(x => x?.name === name);
      return {
        rx: toNum(it?.rx_bytes ?? it?.RxBytes),
        tx: toNum(it?.tx_bytes ?? it?.TxBytes),
      };
    };
    const tun = pick('tun0');
    const eth = pick('eth0');
    return { tunRx: tun.rx, tunTx: tun.tx, ethRx: eth.rx, ethTx: eth.tx };
  }

  function extractSnmp(net){
    // ожидаем net.snmp.udp / net.snmp.tcpext
    const sn   = net?.snmp || {};
    const udp  = sn.udp || {};
    const txe  = sn.tcpext || {};
    return {
      udpErr:     toNum(first(udp.InErrors, udp.in_errors)),
      udpRcvErr:  toNum(first(udp.RcvbufErrors, udp.rcvbuf_errors)),
      tcpTimeouts:toNum(first(txe.TCPTimeouts, txe.tcp_timeouts)),
    };
  }

  function renderDegradationAlert(net){
    const {udpErr, udpRcvErr, tcpTimeouts} = extractSnmp(net);
    const has = (udpErr>0) || (udpRcvErr>0) || (tcpTimeouts>0);
    const el = document.getElementById('net-degradation-alert');
    if (!el) return;
    if (!has){ el.style.display='none'; el.textContent=''; return; }
    el.style.display = 'block';
    el.innerHTML = `Сетевая деградация: UDP InErrors=${udpErr}, RcvbufErrors=${udpRcvErr}, TCPTimeouts=${tcpTimeouts}.
      Проверьте MTU/MSS, rmem/wmem, фильтрацию 1194/UDP, потери в SG/NAT.`;
  }

  function renderBarOrEmpty({id, labels, datasets, stacked=false}){
    if (!labels || !labels.length || !datasets || datasets.length===0 || datasets.every(ds => isAllZeroOrEmpty(ds.data))){
      if (CHARTS[id]) { CHARTS[id].destroy(); delete CHARTS[id]; }
      showEmpty(id, true); return;
    }
    showEmpty(id, false);
    upsertChart(CHARTS, id, () => ({
      type: 'bar',
      data: { labels, datasets },
      options: { responsive:true, maintainAspectRatio:false, animation:false,
        scales:{ x:{ stacked }, y:{ stacked, beginAtZero:true } },
        plugins:{ legend:{ position:'bottom' } } }
    }));
  }

  function renderCpuUsage(info){
    const list = (info && info.cpuList && info.cpuList.List) || [];
    const labels = list.map((_, i) => `CPU${i}`);
    const data = list.map(cpu => {
      const total = (cpu?.User||0)+(cpu?.Sys||0)+(cpu?.Nice||0)+(cpu?.Idle||0)+(cpu?.Wait||0)+(cpu?.Irq||0)+(cpu?.SoftIrq||0)+(cpu?.Stolen||0);
      if (!total) return 0;
      const busy = total - (cpu?.Idle||0);
      return Math.round((busy/total)*1000)/10;
    });
    renderBarOrEmpty({ id:'cpuUsageChart', labels, datasets:[{ label:'Загрузка (%)', data, backgroundColor:palette[0] }] });
  }

  function renderFsUsage(info){
    const fsList = (info && info.fs) || [];
    const labelOf = (fs) => fs.mount || fs.Mount || fs.device || fs.Device || 'fs';
    const usedPctOf = (fs) => (fs.usedPercent ?? fs.UsedPercent ?? 0);
    const labels = fsList.map(labelOf);
    const data   = fsList.map(fs => Math.round(usedPctOf(fs)*10)/10);
    renderBarOrEmpty({ id:'fsUsageChart', labels, datasets:[{ label:'Использовано (%)', data, backgroundColor:palette[2] }] });
  }

  function renderServerTotals(stats){
    const inMB  = ((stats && stats.BytesIn)  || 0) / 1024 / 1024;
    const outMB = ((stats && stats.BytesOut) || 0) / 1024 / 1024;
    renderBarOrEmpty({ id:'serverTotalsChart', labels:['Вход','Выход'],
      datasets:[{ label:'MB', data:[inMB,outMB], backgroundColor:[palette[0],palette[1]] }] });
  }

  function renderConntrackGauge(netinfo){
    const cnt = Number(netinfo?.conntrack?.count||0);
    const max = Number(netinfo?.conntrack?.max||0);
    const id = 'conntrackGauge';
    if (!max) { showEmpty(id, true); return; }
    const used = Math.min(percent(cnt, max), 100);
    const free = 100 - used;
    showEmpty(id, false);
    const ctx = document.getElementById(id); if(!ctx) return;
    ctx.setAttribute('role','progressbar');
    ctx.setAttribute('aria-valuemin','0');
    ctx.setAttribute('aria-valuemax','100');
    ctx.setAttribute('aria-valuenow', String(used));
    upsertChart(CHARTS, id, () => ({
      type:'bar',
      data:{ labels:['Conntrack'], datasets:[
        {label:'Used %', data:[used]},
        {label:'Free %', data:[free]}
      ]},
      options:{
        indexAxis:'y', responsive:true, maintainAspectRatio:false,
        animation:false,
        scales:{x:{stacked:true, beginAtZero:true, max:100}, y:{stacked:true}},
        plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{
          label:(c)=> `${c.dataset.label}: ${c.parsed.x.toFixed(1)}% (${cnt}/${max})`
        }}}
      }
    }));
  }

  function renderSoftnetBars(netinfo){
    const per = netinfo?.softnet?.per_cpu||[];
    const id = 'softnetChart';
    if (!per.length){ showEmpty(id,true); return; }
    const labels = per.map(x=>'CPU'+x.cpu);
    const dropped = per.map(x=> Number(x.dropped||0));
    const tsq = per.map(x=> Number(x.time_squeezed||0));
    showEmpty(id,false);
    upsertChart(CHARTS, id, () => ({
      type:'bar',
      data:{ labels, datasets:[
        {label:'dropped', data:dropped},
        {label:'time_squeezed', data:tsq}
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        scales:{x:{stacked:true}, y:{stacked:false, beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    }));
  }

  function renderIfaceRxTx(netinfo){
    const id = 'ifaceRxTxChart';
    const skip = n => !n || n==='lo' || n.startsWith('docker') || n.startsWith('veth') || n.startsWith('br-');
    const keep = n => ['eth','en','tun','tap','wg'].some(p => n.startsWith(p));
    const ifaces = (netinfo?.ifaces||[]).filter(x => keep(x.name) && !skip(x.name));
    if (!ifaces.length){ showEmpty(id,true); return; }
    const labels = ifaces.map(x=>x.name);
    const rx = ifaces.map(x=> ((x.rx_bytes||0)/1048576).toFixed(1)*1);
    const tx = ifaces.map(x=> ((x.tx_bytes||0)/1048576).toFixed(1)*1);
    if (rx.concat(tx).every(v=>v===0)){ showEmpty(id,true); return; }
    showEmpty(id,false);
    upsertChart(CHARTS, id, () => ({
      type:'bar',
      data:{ labels, datasets:[
        {label:'RX MB', data:rx},
        {label:'TX MB', data:tx}
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    }));
  }

  function renderUdpHealth(netinfo){
    const u = netinfo?.snmp?.udp||{};
    const id = 'udpHealthChart';
    const keys = ['InDatagrams','OutDatagrams','NoPorts','InErrors','RcvbufErrors','SndbufErrors','IgnoredMulti'];
    const vals = keys.map(k => Number(u[k]||0));
    const allZero = !vals.length || vals.every(v=>v===0);
    if (allZero){ showEmpty(id,true); return; }
    showEmpty(id,false);
    upsertChart(CHARTS, id, () => ({
      type:'bar',
      data:{ labels: keys, datasets:[{label:'count', data: vals}]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{legend:{display:false}}
      }
    }));
  }

  function renderNetKPIs(netinfo){
    const tb = document.querySelector('#net-kpis-table tbody'); if(!tb) return;
    tb.innerHTML='';

    const snmp = netinfo?.snmp||{};
    const udp  = snmp.udp||{}, udp6=snmp.udp6||{};
    const te   = snmp.tcpext||{};
    addRow(tb, [safeTd('UDP'), safeTd('InDatagrams'), safeTd(udp.InDatagrams ?? '—'), makeNote('v4')]);
    addRow(tb, [safeTd('UDP'), safeTd('OutDatagrams'), safeTd(udp.OutDatagrams ?? '—'), makeNote('v4')]);
    addRow(tb, [safeTd('UDP'), safeTd('NoPorts'), makeBadgeCell(udp.NoPorts,false), makeNote('v4')]);
    addRow(tb, [safeTd('UDP'), safeTd('InErrors'), makeBadgeCell(udp.InErrors), makeNote('v4')]);
    addRow(tb, [safeTd('UDP'), safeTd('RcvbufErrors'), makeBadgeCell(udp.RcvbufErrors), makeNote('v4')]);
    addRow(tb, [safeTd('UDP'), safeTd('SndbufErrors'), makeBadgeCell(udp.SndbufErrors), makeNote('v4')]);
    if (Object.keys(udp6).length){
      addRow(tb, [safeTd('UDP6'), safeTd('InDatagrams'), safeTd(udp6.InDatagrams ?? '—'), makeNote('v6')]);
      addRow(tb, [safeTd('UDP6'), safeTd('OutDatagrams'), safeTd(udp6.OutDatagrams ?? '—'), makeNote('v6')]);
      if (udp6.NoPorts!==undefined) addRow(tb, [safeTd('UDP6'), safeTd('NoPorts'), makeBadgeCell(udp6.NoPorts,false), makeNote('v6')]);
      if (udp6.InErrors!==undefined) addRow(tb, [safeTd('UDP6'), safeTd('InErrors'), makeBadgeCell(udp6.InErrors), makeNote('v6')]);
    }
    if (te.ListenOverflows!==undefined) addRow(tb,[safeTd('TCP'),safeTd('ListenOverflows'),makeBadgeCell(te.ListenOverflows),makeNote('переполнение accept()')]);
    if (te.ListenDrops!==undefined)     addRow(tb,[safeTd('TCP'),safeTd('ListenDrops'),makeBadgeCell(te.ListenDrops),makeNote('скидывали входящие')]);
    if (te.RetransSegs!==undefined)     addRow(tb,[safeTd('TCP'),safeTd('RetransSegs'),safeTd(te.RetransSegs),makeNote('накопительно')]);
    if (te.TCPTimeouts!==undefined)     addRow(tb,[safeTd('TCP'),safeTd('TCPTimeouts'),safeTd(te.TCPTimeouts),makeNote('RTO таймауты')]);

    const ct=netinfo?.conntrack||{}; const used=Number(ct.count||0), max=Number(ct.max||0);
    const usedPct = max? Math.round((used/max)*1000)/10 : 0;
    addRow(tb,[safeTd('Conntrack'),safeTd('Count'),safeTd(used),makeNote('текущие записи')]);
    addRow(tb,[safeTd('Conntrack'),safeTd('Max'),safeTd(max),makeNote('лимит')]);
    if (ct.buckets!==undefined) addRow(tb,[safeTd('Conntrack'),safeTd('Buckets'),safeTd(ct.buckets),makeNote('хэш-ёмкость')]);
    addRow(tb,[safeTd('Conntrack'),safeTd('Used %'),(()=>{const td=document.createElement('td'); if (!max){ td.textContent='—'; } else { if (usedPct>=85){ const b=makeBadge(usedPct,true); b.className='badge bg-danger'; td.appendChild(b);} else {td.textContent=String(usedPct);} } return td;})(),makeNote('использование пула')]);

    const st=netinfo?.softnet?.total||{};
    addRow(tb,[safeTd('Softnet'),safeTd('Processed'),safeTd(st.processed ?? '—'),makeNote('обработано в softIRQ')]);
    addRow(tb,[safeTd('Softnet'),safeTd('Dropped'),makeBadgeCell(st.dropped),makeNote('потери до сокетов')]);
    addRow(tb,[safeTd('Softnet'),safeTd('TimeSqueezed'),safeTd(st.time_squeezed ?? '—'),makeNote('давление по времени')]);

    const lim=netinfo?.udp_mem_limits||{};
    if (Array.isArray(lim.udp_mem) && lim.udp_mem.length===3){
      addRow(tb,[safeTd('UDP mem'),safeTd('udp_mem (low/pressure/high)'),safeTd(`${lim.udp_mem[0]} / ${lim.udp_mem[1]} / ${lim.udp_mem[2]}`),makeNote('страницы')]);
    }
    addRow(tb,[safeTd('UDP mem'),safeTd('udp_rmem_min'),safeTd(lim.udp_rmem_min ?? '—'),makeNote('байт')]);
    addRow(tb,[safeTd('UDP mem'),safeTd('udp_wmem_min'),safeTd(lim.udp_wmem_min ?? '—'),makeNote('байт')]);
    addRow(tb,[safeTd('Core mem'),safeTd('rmem_default / rmem_max'),safeTd(`${lim.core_rmem_default??'—'} / ${lim.core_rmem_max??'—'}`),makeNote('байт')]);
    addRow(tb,[safeTd('Core mem'),safeTd('wmem_default / wmem_max'),safeTd(`${lim.core_wmem_default??'—'} / ${lim.core_wmem_max??'—'}`),makeNote('байт')]);

    const s4=netinfo?.sock_stat||{}, s6=netinfo?.sock_stat6||{};
    const tcpIn=(s4.tcp?.inuse||0)+(s6.tcp?.inuse||0);
    const tcpTw=(s4.tcp?.tw||0)+(s6.tcp?.tw||0);
    const tcpOr=(s4.tcp?.orphan||0)+(s6.tcp?.orphan||0);
    addRow(tb,[safeTd('Sockstat'),safeTd('TCP inuse / tw / orphan'),safeTd(`${tcpIn} / ${tcpTw} / ${tcpOr}`),safeTd('')]);
    const udpIn=(s4.udp?.inuse||0)+(s6.udp?.inuse||0);
    addRow(tb,[safeTd('Sockstat'),safeTd('UDP inuse'),safeTd(udpIn),safeTd('')]);
    if (s4.sockets_inuse!==undefined) addRow(tb,[safeTd('Sockstat'),safeTd('sockets_inuse (all)'),safeTd(s4.sockets_inuse),safeTd('')]);

    const ifs=netinfo?.ifaces||[];
    const f = n => ifs.find(x=>x.name===n);
    ['eth0','tun0'].forEach(n=>{
      const it=f(n); if(!it) return;
      const rx=mb(it.rx_bytes||0).toFixed(1), tx=mb(it.tx_bytes||0).toFixed(1);
      const errs=(Number(it.rx_errors||0)+Number(it.tx_errors||0));
      const drops=(Number(it.rx_dropped||0)+Number(it.tx_dropped||0));
      addRow(tb,[safeTd(`Iface ${n}`),safeTd('RX/TX (MB)'),safeTd(`${rx} / ${tx}`),makeNote('накоп.')]);
      addRow(tb,[safeTd(`Iface ${n}`),safeTd('Errors'),makeBadgeCell(errs),makeNote('RX+TX')]);
      addRow(tb,[safeTd(`Iface ${n}`),safeTd('Dropped'),makeBadgeCell(drops),makeNote('RX+TX')]);
      addRow(tb,[safeTd(`Iface ${n}`),safeTd('Oper/MTU'),safeTd(`${it.operstate||'—'} / ${it.mtu||'—'}`),safeTd('')]);
    });

    const w = netinfo?.warnings||[];
    const wEl=document.getElementById('net-warnings');
    if (wEl){
      wEl.innerHTML='';
      if (w.length){
        const lbl=document.createElement('span'); lbl.textContent='Предупреждения: '; wEl.appendChild(lbl);
        w.forEach(x=>{ const span=document.createElement('span'); span.className='badge bg-warning text-dark me-1'; span.textContent=x; wEl.appendChild(span); });
      } else { wEl.textContent=''; }
    }
  }

  function renderNetKPI(d){
    const s4 = d?.sock_stat || {};
    const s6 = d?.sock_stat6 || {};
    const tcpIn = (s4.tcp?.inuse||0) + (s6.tcp?.inuse||0);
    const tcpTw = (s4.tcp?.tw||0)    + (s6.tcp?.tw||0);
    const tcpOr = (s4.tcp?.orphan||0)+(s6.tcp?.orphan||0);
    const udpIn = (s4.udp?.inuse||0) + (s6.udp?.inuse||0);
    const udpMem= (s4.udp?.mem||0)   + (s6.udp?.mem||0);

    const ctUsed = Number(d?.conntrack?.count||0);
    const ctMax  = Number(d?.conntrack?.max||0);
    const tcpTotal = Number(d?.tcp_states?.total||0);

    const set = (id, val) => { const el=document.getElementById(id); if (el) el.textContent = val; };
    set('kpi-tcp-inuse', `${tcpIn} / ${tcpTw} / ${tcpOr}`);
    set('kpi-udp-inuse', `${udpIn}, mem=${udpMem}`);
    set('kpi-ct-used',   ctMax ? `${ctUsed} / ${ctMax}` : '—');
    set('kpi-tcp-total', `${tcpTotal}`);
  }

  function renderTCPStatesChart(d){
    const id='tcpStatesChart';
    const st=d?.tcp_states||{};
    const labels=['LISTEN','ESTABLISHED','SYN-SENT','SYN-RECV','FIN-WAIT1','FIN-WAIT2','TIME-WAIT','CLOSE','CLOSE-WAIT','LAST-ACK','CLOSING','NEW-SYN-RECV','UNKNOWN'];
    const keys  =['listen','established','syn_sent','syn_recv','fin_wait1','fin_wait2','time_wait','close','close_wait','last_ack','closing','new_syn_recv','unknown'];
    const vals=keys.map(k=>Number(st[k]||0));
    if (!vals.length || vals.every(v=>v===0)){ if(CHARTS[id]){CHARTS[id].destroy(); delete CHARTS[id];} showEmpty(id,true); return; }
    showEmpty(id,false);
    upsertChart(CHARTS, id, () => ({
      type:'doughnut',
      data:{labels,datasets:[{data:vals}]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{position:'bottom'}}}
    }));
  }

  function renderTcpTopPortsChart(d){
    const id='tcpTopPortsChart';
    const ps=d?.tcp_socket_stats?.port_stats||[];
    if (!ps.length){ if(CHARTS[id]){CHARTS[id].destroy(); delete CHARTS[id];} showEmpty(id,true); return; }
    const labels=ps.map(p=>String(p.port));
    const rx=ps.map(p=>Number(p.rx_queue||0));
    const tx=ps.map(p=>Number(p.tx_queue||0));
    if (rx.concat(tx).every(v=>v===0)){ if(CHARTS[id]){CHARTS[id].destroy(); delete CHARTS[id];} showEmpty(id,true); return; }
    showEmpty(id,false);
    upsertChart(CHARTS, id, () => ({
      type:'bar',
      data:{labels,datasets:[
        {label:'RX queue',data:rx},
        {label:'TX queue',data:tx},
      ]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{beginAtZero:true},y:{stacked:true}},
        plugins:{legend:{position:'bottom'}}
      }
    }));
  }

  function renderUdpTopPortsChart(d){
    const id='udpTopPortsChart';
    const ps=d?.udp_port_stats||[];
    if (!ps.length){ if(CHARTS[id]){CHARTS[id].destroy(); delete CHARTS[id];} showEmpty(id,true); return; }
    const labels=ps.map(p=>String(p.port));
    const rx=ps.map(p=>Number(p.rx_queue||0));
    const tx=ps.map(p=>Number(p.tx_queue||0));
    const drops=ps.map(p=>Number(p.drops||0));
    if (rx.concat(tx).every(v=>v===0) && drops.every(v=>v===0)){ if(CHARTS[id]){CHARTS[id].destroy(); delete CHARTS[id];} showEmpty(id,true); return; }
    showEmpty(id,false);
    upsertChart(CHARTS, id, () => ({
      type:'bar',
      data:{labels,datasets:[
        {label:'RX queue',data:rx},
        {label:'TX queue',data:tx},
        {type:'line',label:'drops',data:drops,yAxisID:'y2'}
      ]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,
        scales:{x:{beginAtZero:true},y:{stacked:true},y2:{position:'right',beginAtZero:true,grid:{display:false}}},
        plugins:{legend:{position:'bottom'}}
      }
    }));
  }

  function applyCipherBadges(){
    const classify=(cipher)=>{
      const lower=(cipher||'').toLowerCase();
      if (!cipher) return [];
      if (lower.startsWith('kuznyechik')) return ['ГОСТ'];
      if (lower.includes('gcm')) return ['AEAD'];
      return ['CBC'];
    };
    const activeCipher=document.getElementById('kpi-active-cipher');
    const badgeWrap=document.getElementById('kpi-active-cipher-badges');
    if (activeCipher && badgeWrap){
      badgeWrap.innerHTML='';
      const cipherText=(activeCipher.textContent||'').trim();
      const tags=classify(cipherText);
      tags.forEach(tag=>{ const b=document.createElement('span'); b.className = tag==='ГОСТ'?'badge bg-warning text-dark me-1': (tag==='AEAD'?'badge bg-success me-1':'badge bg-secondary me-1'); b.textContent=tag; badgeWrap.appendChild(b); });
      if (!cipherText){ badgeWrap.textContent='—'; }
    }
    document.querySelectorAll('td[data-cipher]').forEach(td=>{
      const cipher=td.getAttribute('data-cipher')||'';
      const tags=classify(cipher);
      tags.forEach(tag=>{ const b=document.createElement('span'); b.className= tag==='ГОСТ'?'badge bg-warning text-dark ms-1':'badge bg-secondary ms-1'; b.textContent=tag; td.appendChild(b); });
    });
  }

  function renderDcoBadge(){
    const wrap=document.getElementById('dco-badge'); if(!wrap) return;
    wrap.innerHTML='';
    const title = (ovstatus && ovstatus.Title) ? String(ovstatus.Title) : '';
    const badge=document.createElement('span');
    if (title && title.includes('DCO')){
      badge.className='badge bg-success me-2';
      badge.textContent='DCO';
      wrap.appendChild(badge);
    } else {
      badge.className='badge bg-warning text-dark me-2';
      badge.textContent='DCO не активен';
      wrap.appendChild(badge);
      const hint=document.createElement('span'); hint.className='small-muted'; hint.textContent='ускорение через ядро'; wrap.appendChild(hint);
    }
  }

  function computeEfficiency(){
    const el=document.getElementById('kpi-vpn-eff'); if(!el) return;
    const ovIn=Number(el.dataset.ovIn||0); const ovOut=Number(el.dataset.ovOut||0);
    const tunRx=Number(el.dataset.tunRx||0); const tunTx=Number(el.dataset.tunTx||0);
    const ethRx=Number(el.dataset.ethRx||0); const ethTx=Number(el.dataset.ethTx||0);
    let payload=0; if ((ovIn+ovOut)>0){ payload=ovIn+ovOut; } else if ((tunRx+tunTx)>0){ payload=tunRx+tunTx; }
    const wire=ethRx+ethTx;
    if (!payload || !wire){ el.textContent='—'; } else {
      const eff=Math.round((payload/Math.max(1,wire))*100);
      el.textContent=`${eff}%`;
    }
    const asym=document.getElementById('kpi-vpn-asym');
    const tunTotal=tunRx+tunTx;
    if (asym){ asym.textContent = tunTotal? `${Math.round((tunTx/Math.max(1,tunTotal))*100)}% OUT` : '—'; }
  }

  // ===== Firewall rendering =====
  const hookNames = {"0":"PREROUTING","1":"INPUT","2":"FORWARD","3":"OUTPUT","4":"POSTROUTING","":""};
  function ensureFwAvailable(){ const has = fw && fw.summary; if (has) return true; document.querySelectorAll('.fw-section').forEach(s=>{ s.querySelectorAll('.empty-state').forEach(es=>es.style.display='flex'); }); return false; }
  function renderFwKpis(){ if(!ensureFwAvailable()) return; const totals=fw.summary?.totals||{}; document.getElementById('fw-kpi-total-packets').textContent=fmtPackets(totals.packets); document.getElementById('fw-kpi-total-bytes').textContent=fmtBytes(totals.bytes); const verdicts=fw.summary?.by_verdict||[]; const totalPkt=verdicts.reduce((s,v)=>s+toNum(v.packets),0)||1; const pct = (v)=>Math.round((toNum(v)/totalPkt)*100); const a=verdicts.find(v=>v.verdict==='ACCEPT')||{}; const j=verdicts.find(v=>v.verdict==='JUMP')||{}; const d=verdicts.find(v=>v.verdict==='DROP')||{}; const r=verdicts.find(v=>v.verdict==='RETURN')||{}; document.getElementById('fw-kpi-verdicts').textContent=`A ${pct(a.packets||0)}% • J ${pct(j.packets||0)}% • D ${pct(d.packets||0)}%`;
    const counts=fw.counts||{}; document.getElementById('fw-kpi-chains-rules').textContent=`${counts.chains_total||0} / ${counts.rules_total||counts.rules_shown||0}`;
    const fwd=document.getElementById('fw-kpi-forward-policy'); if(fw.has_forward_policy_accept){ fwd.innerHTML='<span class="badge bg-success">ACCEPT</span>'; } else if(fw.has_forward_policy_drop){ fwd.innerHTML='<span class="badge bg-danger">DROP</span>'; } else { fwd.textContent='—'; }
    const def=document.getElementById('fw-kpi-default-route'); if(def){ const has=!!fw.has_default_route; def.innerHTML=`<span class="badge ${has?'pill-ok':'pill-warn'}">${has?'on':'off'}</span>`; }
  }
  function renderFwVerdicts(){ const id='fw-verdict-donut'; if(!ensureFwAvailable()) { showEmpty(id,true); return; } const verdicts=fw.summary?.by_verdict||[]; const packets=verdicts.map(v=>toNum(v.packets)); if(!packets.length || packets.every(v=>v===0)){ showEmpty(id,true); return; } showEmpty(id,false); const labels=verdicts.map(v=>v.verdict); const colors=labels.map(verdictColor); const bytes=verdicts.map(v=>toNum(v.bytes)); document.getElementById('fw-verdict-bytes-mini').textContent = verdicts.map((v,i)=>`${v.verdict} ${percent(bytes[i], bytes.reduce((s,x)=>s+x,0)||1).toFixed(0)}%`).join(' • ');
    upsertChart(CHARTS, id, ()=>({ type:'doughnut', data:{ labels, datasets:[{ data:packets, backgroundColor:colors }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }}));
  }
  function flattenChains(){ const out=[]; (fw.tables||[]).forEach(t=>{ (t.chains||[]).forEach(c=>out.push({table:t.name,family:t.family,...c})); }); return out; }
  function renderTopChains(metric){ const id='fw-top-chains'; if(!ensureFwAvailable()) { showEmpty(id,true); return; } const chains=flattenChains().filter(c=>toNum(c.packet_count)+toNum(c.byte_count)>0); const sorted=chains.sort((a,b)=> toNum(b[metric]) - toNum(a[metric])).slice(0,10); if(!sorted.length){ showEmpty(id,true); return; } showEmpty(id,false); const labels=sorted.map(c=>`${c.table}/${c.name}`); const data=sorted.map(c=>toNum(c[metric])); upsertChart(CHARTS,id,()=>({ type:'bar', data:{labels, datasets:[{label:metric, data, backgroundColor:palette[0]}]}, options:{indexAxis:'y', responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}} }})); }
  function makePolicyBadge(pol){ if(!pol) return '—'; const cls = pol==='ACCEPT'?'badge bg-success':'badge bg-danger'; return `<span class="${cls}">${pol}</span>`; }
  function renderChainsTable(){ if(!ensureFwAvailable()) return; const famSel=document.getElementById('fw-filter-family').value; const hookSel=document.getElementById('fw-filter-hook').value; const polSel=document.getElementById('fw-filter-policy').value; const pktThr=toNum(document.getElementById('fw-filter-packets').value||0); const tb=document.querySelector('#fw-chains-table tbody'); tb.innerHTML=''; flattenChains().forEach(ch=>{ if(famSel!=='both' && ch.family!==famSel) return; if(hookSel!=='all' && String(ch.hook||'')!==hookSel) return; const pol=(ch.policy||''); if(polSel==='none' && pol) return; if(polSel!=='any' && polSel!=='none' && pol!==polSel) return; if(toNum(ch.packet_count)<pktThr && toNum(ch.byte_count)<pktThr) return; const tr=document.createElement('tr'); const rulesLen=(ch.rules||[]).length; tr.innerHTML=`<td>${ch.family}</td><td>${ch.table}/${ch.name}</td><td>${hookNames[ch.hook||'']||''}</td><td>${makePolicyBadge(pol)}</td><td class="mono">${fmtPackets(ch.packet_count)}</td><td class="mono">${fmtBytes(ch.byte_count)}</td><td>${rulesLen}</td><td><button class="btn btn-xs btn-outline-primary" data-chain="${ch.table}/${ch.name}">Открыть</button></td>`; tb.appendChild(tr); }); }
  function renderChainDetail(chainKey){ const wrap=document.getElementById('fw-chain-detail'); if(!wrap) return; wrap.innerHTML=''; if(!chainKey) return; const [table,name]=chainKey.split('/'); const ch=flattenChains().find(c=>c.table===table && c.name===name); if(!ch){ wrap.textContent='Chain not found'; return; } const meta=`${ch.table}/${ch.name} • ${hookNames[ch.hook||'']||''} • policy ${ch.policy||'—'}`; const counters=`Packets ${fmtPackets(ch.packet_count)} • Bytes ${fmtBytes(ch.byte_count)}`; const ruleBar=(ch.rules||[]).map(r=>r.verdict||'').reduce((acc,v)=>{ acc[v]=(acc[v]||0)+1; return acc; },{}); const barHTML=Object.entries(ruleBar).map(([k,v])=>`<span class="badge me-1" style="background:${verdictColor(k)}">${k}: ${v}</span>`).join('');
    wrap.innerHTML=`<div class="card-clean"><div class="card-body"><div class="mb-1"><b>${meta}</b></div><div class="small-muted mb-2">${counters}</div><div class="mb-2">${barHTML||''}</div><div class="table-responsive" style="max-height:260px; overflow:auto"><table class="table table-sm"><thead><tr><th>#</th><th>Expr</th><th>Verdict</th><th>Packets</th><th>Bytes</th></tr></thead><tbody>${(ch.rules||[]).map(r=>`<tr><td>${r.index}</td><td><span title="${r.expr||''}">${r.expr||''}</span></td><td><span class="badge" style="background:${verdictColor(r.verdict)}">${r.verdict||''}</span></td><td class="mono">${fmtPackets(r.packets)}</td><td class="mono">${fmtBytes(r.bytes)}</td></tr>`).join('')}</tbody></table></div></div></div>`;
  }
  function renderRulesTable(){ if(!ensureFwAvailable()) return; const tb=document.querySelector('#fw-rules-table tbody'); const term=(document.getElementById('fw-rules-search').value||'').toLowerCase(); const preset=document.getElementById('fw-rules-preset').value; const rules=fw.flat_rules||[]; const filtered=rules.filter(r=>{ const expr=(r.expr||'').toLowerCase(); const matches=(r.matches||[]).join(' ').toLowerCase(); const family=r.table?.split('/')[0]; if(term && !expr.includes(term) && !matches.includes(term)) return false; switch(preset){ case 'INPUT-dpt': return r.chain==='INPUT' && expr.includes('dpt='); case 'DOCKER': return r.chain?.startsWith('DOCKER'); case 'ip-nat': return r.table==='ip/nat' && (r.chain==='PREROUTING' || r.chain==='POSTROUTING'); case 'ipv6': return family==='ip6'; case 'DROP': return (r.verdict||'').toUpperCase()==='DROP'; default: return true; }
    });
    tb.innerHTML=filtered.map(r=>{ const family=(r.table||'').split('/')[0]; const matches=(r.matches||[]).join(', '); return `<tr><td>${family}</td><td>${r.table}</td><td>${r.chain}</td><td>${r.index}</td><td><span title="${r.expr||''}">${r.expr||''}</span></td><td>${matches}</td><td><span class="badge" style="background:${verdictColor(r.verdict)}">${r.verdict||''}</span></td><td class="mono">${fmtPackets(r.packets)}</td><td class="mono">${fmtBytes(r.bytes)}</td></tr>`; }).join('');
  }
  function renderPortsTable(){ if(!ensureFwAvailable()) return; const tb=document.querySelector('#fw-ports-input-table tbody'); const rules=(fw.flat_rules||[]).filter(r=>r.table==='ip/filter' && r.chain==='INPUT'); const groups={}; rules.forEach(r=>{ const text=`${r.matches||''} ${r.expr||''}`; const m=text.match(/dpt=(\d+)/); if(!m) return; const port=m[1]; const protoMatch=text.match(/proto=(tcp|udp)/); const proto=protoMatch?protoMatch[1]:'—'; const key=`${port}-${proto}`; if(!groups[key]) groups[key]={port,proto,packets:0,bytes:0,count:0,jump:text.includes('JUMP')}; groups[key].packets+=toNum(r.packets); groups[key].bytes+=toNum(r.bytes); groups[key].count+=1; }); tb.innerHTML=Object.values(groups).sort((a,b)=>b.packets-a.packets).map(g=>`<tr><td class="mono">${g.port}</td><td>${g.proto}</td><td class="mono">${fmtPackets(g.packets)}</td><td class="mono">${fmtBytes(g.bytes)}</td><td>${g.count}</td><td><span class="badge ${g.packets>0?'bg-success':'bg-secondary'}">${g.packets>0?'traffic':'mute'}</span></td><td>${g.jump?'JUMP':'direct'}</td></tr>`).join('');
  }
  function renderNat(){ if(!ensureFwAvailable()) return; const natCards=document.getElementById('fw-nat-cards'); natCards.innerHTML=''; const natTables=(fw.tables||[]).filter(t=>t.name==='ip/nat'); if(!natTables.length) return; const chainNames=['PREROUTING','POSTROUTING','OUTPUT']; chainNames.forEach(name=>{ const ch=natTables[0].chains?.find(c=>c.name===name); const card=document.createElement('div'); card.className='col-md-4 mb-3'; card.innerHTML=`<div class="kpi-box"><div class="kpi-box__title">${name}</div><div class="kpi-box__value mono">${fmtPackets(ch?.packet_count)}</div><div class="kpi-box__muted">${fmtBytes(ch?.byte_count)}</div></div>`; natCards.appendChild(card); });
    const tb=document.querySelector('#fw-nat-table tbody'); tb.innerHTML=''; (natTables[0].chains||[]).filter(c=>['PREROUTING','POSTROUTING','OUTPUT'].includes(c.name)).forEach(c=>{ (c.rules||[]).forEach(r=>{ tb.innerHTML += `<tr><td>${c.name}</td><td>${r.index}</td><td>${r.expr||''}</td><td>${r.verdict||''}</td><td class="mono">${fmtPackets(r.packets)}</td><td class="mono">${fmtBytes(r.bytes)}</td></tr>`; }); });
  }
  function renderDocker(){ if(!ensureFwAvailable()) return; const tb=document.querySelector('#fw-docker-table tbody'); const dockerChains=flattenChains().filter(c=>c.name && c.name.startsWith('DOCKER')); tb.innerHTML=dockerChains.map(c=>{ const rlen=(c.rules||[]).length; return `<tr><td>${c.table}/${c.name}</td><td class=\"mono\">${fmtPackets(c.packet_count)}</td><td class=\"mono\">${fmtBytes(c.byte_count)}</td><td>${rlen}</td><td>${c.packet_count?'' :'изолирующая цепь, трафика нет'}</td></tr>`; }).join(''); const flow=document.getElementById('fw-docker-flow'); const fwd=flattenChains().find(c=>c.name==='DOCKER-FORWARD'); if(flow){ const rules=(fwd?.rules||[]).map(r=>`${r.verdict} (${fmtPackets(r.packets)}/${fmtBytes(r.bytes)})`).join(' → '); flow.textContent = rules || 'Нет данных по DOCKER-FORWARD'; }
  }
  function renderIpv6(){ if(!ensureFwAvailable()) return; const cards=document.getElementById('fw-ipv6-cards'); cards.innerHTML=''; const t=(fw.tables||[]).find(t=>t.name==='ip6/filter'); if(!t) return; const names=['INPUT','FORWARD','OUTPUT']; names.forEach(n=>{ const ch=t.chains?.find(c=>c.name===n); const col=document.createElement('div'); col.className='col-md-4 mb-3'; const policy=ch?.policy||'—'; const badge=makePolicyBadge(policy); col.innerHTML=`<div class="kpi-box"><div class="kpi-box__title">ip6/filter/${n}</div><div class="kpi-box__value">${badge}</div><div class="kpi-box__muted">${fmtPackets(ch?.packet_count)} / ${fmtBytes(ch?.byte_count)}</div></div>`; cards.appendChild(col); }); const id='fw-ipv6-verdict-donut'; const rules=(t.chains||[]).flatMap(c=>c.rules||[]); const agg=rules.reduce((acc,r)=>{ const v=r.verdict||'other'; acc[v]=(acc[v]||0)+toNum(r.packets); return acc; },{}); const labels=Object.keys(agg); const data=Object.values(agg); if(!data.length){ showEmpty(id,true); return; } showEmpty(id,false); upsertChart(CHARTS,id,()=>({type:'doughnut', data:{labels,datasets:[{data,backgroundColor:labels.map(verdictColor)}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}})); }
  function renderDiagnostics(){ if(!ensureFwAvailable()) return; const alerts=document.getElementById('fw-alerts'); const warn=fw.warnings||{}; const make=(type,msg)=>`<div class="alert ${type==='Critical'?'alert-danger':type==='Warning'?'alert-warning':'alert-info'}">${msg}</div>`; alerts.innerHTML=''; (warn.openvpn||[]).forEach(m=>alerts.innerHTML+=make('Critical',m)); (warn.policy||[]).forEach(m=>alerts.innerHTML+=make('Warning',m)); (warn.routing||[]).forEach(m=>alerts.innerHTML+=make('Warning',m)); (warn.parser||[]).forEach(m=>alerts.innerHTML+=make('Info',m)); const matrix=document.querySelector('#fw-policy-matrix tbody'); matrix.innerHTML=''; ['0','1','2','3','4'].forEach(h=>{ const row=document.createElement('tr'); const ipv4=flattenChains().find(c=>c.family==='ip' && String(c.hook||'')===h); const ipv6=flattenChains().find(c=>c.family==='ip6' && String(c.hook||'')===h); row.innerHTML=`<td>${hookNames[h]}</td><td>${makePolicyBadge(ipv4?.policy||'')}</td><td>${makePolicyBadge(ipv6?.policy||'')}</td>`; matrix.appendChild(row); }); }
  function renderFirewall(){ if(!fw || Object.keys(fw).length===0){ ensureFwAvailable(); return; } renderFwKpis(); lazyChart('fw-verdict-donut', renderFwVerdicts); let metric='packet_count'; const topBtn=document.getElementById('fw-top-metric'); if(topBtn){ topBtn.addEventListener('click',()=>{ metric= metric==='packet_count' ? 'byte_count' : 'packet_count'; topBtn.textContent = metric==='packet_count'?'packets':'bytes'; renderTopChains(metric); }); }
    renderTopChains(metric); ['fw-filter-family','fw-filter-hook','fw-filter-policy','fw-filter-packets'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input',()=>renderChainsTable()); }); const chainsTable=document.querySelector('#fw-chains-table'); if(chainsTable){ chainsTable.addEventListener('click',e=>{ const target=e.target; const key=target && target.dataset ? target.dataset.chain : null; if(key) renderChainDetail(key); }); } renderChainsTable(); renderRulesTable(); const search=document.getElementById('fw-rules-search'); if(search) search.addEventListener('input',renderRulesTable); const presetSel=document.getElementById('fw-rules-preset'); if(presetSel) presetSel.addEventListener('change',renderRulesTable); renderPortsTable(); renderNat(); renderDocker(); lazyChart('fw-ipv6-verdict-donut', renderIpv6); renderDiagnostics(); }

  function renderNetSection(){
    renderNetKPI(netinfoData);
    renderConntrackGauge(netinfoData);
    lazyChart('softnetChart', ()=>renderSoftnetBars(netinfoData));
    lazyChart('tcpStatesChart', ()=>renderTCPStatesChart(netinfoData));
    lazyChart('tcpTopPortsChart', ()=>renderTcpTopPortsChart(netinfoData));
    lazyChart('ifaceRxTxChart', ()=>renderIfaceRxTx(netinfoData));
    lazyChart('udpHealthChart', ()=>renderUdpHealth(netinfoData));
    lazyChart('udpTopPortsChart', ()=>renderUdpTopPortsChart(netinfoData));
    renderNetKPIs(netinfoData);
  }

  // ---- Подготовка данных для KPI Эффективность VPN ----
  (function primeVpnEfficiency(){
    const el = document.getElementById('kpi-vpn-eff');
    if (!el) return;
    const {tunRx, tunTx, ethRx, ethTx} = extractIfaceBytes(netinfoData);
    el.dataset.ovIn   = String(toNum(ovstats?.BytesIn));
    el.dataset.ovOut  = String(toNum(ovstats?.BytesOut));
    el.dataset.tunRx  = String(tunRx);
    el.dataset.tunTx  = String(tunTx);
    el.dataset.ethRx  = String(ethRx);
    el.dataset.ethTx  = String(ethTx);
  })();

  renderCpuUsage(sysinfoData);
  lazyChart('fsUsageChart', ()=>renderFsUsage(sysinfoData));
  renderServerTotals(ovstats);
  renderNetSection();
  computeEfficiency();
  applyCipherBadges();
  renderDcoBadge();
  renderDegradationAlert(netinfoData);
  renderFirewall();
  
  new ResizeObserver(()=>Object.values(CHARTS).forEach(ch=>{ if (ch) ch.resize(); })).observe(document.body);

  const themeBtn=document.getElementById('theme-toggle');
  const applyTheme=(mode)=>{
    if (mode==='dark'){ document.body.classList.add('force-dark'); }
    else if(mode==='auto'){ document.body.classList.remove('force-dark'); if (window.matchMedia('(prefers-color-scheme: dark)').matches){ document.body.classList.add('force-dark'); }}
    else { document.body.classList.remove('force-dark'); }
  };
  const storedTheme=localStorage.getItem('ui-theme')||'auto';
  applyTheme(storedTheme);
  if (themeBtn){
    themeBtn.textContent = storedTheme==='dark' ? 'Тема: тёмная' : 'Тема: авто';
    themeBtn.addEventListener('click', ()=>{
      const current=localStorage.getItem('ui-theme')||'auto';
      const next = current==='dark' ? 'auto' : 'dark';
      localStorage.setItem('ui-theme', next);
      applyTheme(next);
      themeBtn.textContent = next==='dark' ? 'Тема: тёмная' : 'Тема: авто';
    });
  }

  (function(){
    const btns = document.querySelectorAll('.button-copy');
    btns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const txt = b.getAttribute('data-clipboard-text') || '';
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(()=> {
          const icon = b.querySelector('.clippy'); if (!icon) return;
          icon.style.opacity = 1; setTimeout(()=>{ icon.style.opacity = .6; }, 800);
        });
      });
    });
  })();
</script>

{{end}}
