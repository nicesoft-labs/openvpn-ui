{{ template "layout/base.html" . }}

{{define "head"}}
<title>NiceSOFT NiceVPN UI — Сводка</title>
<style>
  /* ===== Корпоративный нейтральный стиль ===== */
  .kpi-box{border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,.05); padding:16px; background:#fff; height:100%}
  .kpi-box__title{font-size:.9rem; color:#6c757d; margin-bottom:.25rem}
  .kpi-box__value{font-size:1.6rem; font-weight:700; line-height:1.1}
  .kpi-box__muted{color:#6c757d; font-size:.9rem}
  .card-clean{border:1px solid #e9ecef; border-radius:14px; background:#fff; box-shadow:0 3px 10px rgba(0,0,0,.04)}
  .card-clean .card-header{border-bottom:1px solid #eef1f4; background:#fff; border-top-left-radius:14px; border-top-right-radius:14px}
  .card-clean .card-body{padding:16px}
  .metric-card{border:1px solid #e9ecef; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.03); background:#fff}
  .metric-card__header{font-weight:600; margin-bottom:8px}
  /* Фиксированная высота графиков, чтобы сетка не "плыла" без данных */
  .metric-card .chart-wrap{position:relative; height:220px}
  .metric-card canvas{width:100% !important; height:100% !important}
  /* Статусы */
  .status-pill{display:inline-flex; align-items:center; padding:5px 12px; border-radius:999px; font-weight:700; font-size:.9rem; color:#fff; letter-spacing:.03em; text-transform:uppercase}
  .status-pill.pill-mini{font-size:.8rem; padding:4px 10px}
  .pill-ok{background:#28a745}
  .pill-warn{background:#ffc107; color:#212529}
  .pill-bad{background:#dc3545}
  .small-muted{font-size:.85rem; color:#6c757d}
  /* Плейсхолдер «Нет данных» */
  .empty-state{
    display:none; align-items:center; justify-content:center;
    height:220px; border:2px dashed #e9ecef; border-radius:10px; color:#6c757d;
    font-size:.95rem; background:#fafafa;
  }
  .empty-state .hint{font-size:.85rem; color:#9aa0a6; margin-left:.5rem}
  /* Прогрессы памяти */
  .progress-xs{height:10px}
  .progress-number{font-weight:600}
  /* Таблица клиентов */
  .table thead th{white-space:nowrap}
  .button-transparent{background:transparent;border:0;padding:0;margin-left:6px}
  .clippy{opacity:.6}
  .clippy:hover{opacity:1}
</style>
{{end}}

{{define "body"}}

<!-- ===== Верхние KPI ===== -->
<div class="row">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Подключённые клиенты</div>
      <div class="kpi-box__value">{{ if .ovstats }}{{ .ovstats.NClients }}{{ else }}0{{ end }}</div>
      <div class="kpi-box__muted">
        Вход: {{ if .ovstats }}{{ printmb .ovstats.BytesIn }}{{ else }}0{{ end }} MB •
        Выход: {{ if .ovstats }}{{ printmb .ovstats.BytesOut }}{{ else }}0{{ end }} MB
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Нагрузка (Load Average)</div>
      <div class="kpi-box__value">
        1м: {{ .sysinfo.LoadAvg.One }}
      </div>
      <div class="kpi-box__muted">5м: {{ .sysinfo.LoadAvg.Five }} • 15м: {{ .sysinfo.LoadAvg.Fifteen }}</div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Аптайм ОС</div>
      <div class="kpi-box__value">{{ .sysinfo.UptimeS }}</div>
      <div class="kpi-box__muted">Стабильность хоста</div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Время сервера</div>
      <div class="kpi-box__value">
        {{ dateformat .sysinfo.CurrentTime "2006-01-02 15:04:05" }}
      </div>
      <div class="kpi-box__muted">{{ .sysinfo.Os }} • {{ .sysinfo.Arch }}</div>
    </div>
  </div>
</div>

<!-- ===== Management & Queue ===== -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-3">
    <div class="card-clean h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="kpi-box__title mb-0">Management</div>
          <div class="d-flex gap-2" style="gap:8px">
            <span class="status-pill pill-mini pill-warn" id="mgmt-state-pill">state</span>
            <span class="status-pill pill-mini pill-warn" id="mgmt-log-pill">log</span>
            <span class="status-pill pill-mini pill-warn" id="mgmt-bytecount-pill">bytecount</span>
          </div>
        </div>
        <div class="kpi-box__muted mb-0">Переподключений за 24ч: <span id="mgmt-reconnects">0</span></div>
      </div>
    </div>
  </div>
  <div class="col-lg-6 col-md-12 mb-3">
    <div class="card-clean h-100">
      <div class="card-body">
        <div class="kpi-box__title">Очередь широковещания/мультикаста</div>
        <div class="kpi-box__value" id="bcast-queue-val" style="font-size:1.4rem">0</div>
        <div class="kpi-box__muted">GLOBAL STATS → Max bcast/mcast queue length</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Память / Swap ===== -->
<h5 class="mt-2 mb-2">Память</h5>
<div class="row">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            ОЗУ: <b>{{ printmb .sysinfo.Memory.Used }}</b> / {{ printmb .sysinfo.Memory.Total }} MB — {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-primary progress-bar-striped"
                 style="width: {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            Swap: <b>{{ printmb .sysinfo.Swap.Used }}</b> / {{ printmb .sysinfo.Swap.Total }} MB — {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-secondary progress-bar-striped"
                 style="width: {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Графики (минимально необходимое) ===== -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">
        Суммарный трафик OpenVPN
        <small class="text-secondary d-block">openvpn_server_bytes_*_total</small>
      </div>
      <div class="chart-wrap">
        <canvas id="serverTotalsChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="serverTotalsChart">
        Нет данных для отображения<span class="hint"> (подключите management/status)</span>
      </div>
      <small class="text-muted d-block mt-2">Источник: management (load-stats) / status.</small>
    </div>
  </div>

  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">
        Распределение трафика по клиентам
        <small class="text-secondary d-block">openvpn_client_bytes_*_total</small>
      </div>
      <div class="chart-wrap">
        <canvas id="clientTrafficChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="clientTrafficChart">
        Нет активных сессий<span class="hint"> (клиенты не подключены)</span>
      </div>
      <small class="text-muted d-block mt-2">Показывает входящий/исходящий трафик (MB) по активным сессиям.</small>
    </div>
  </div>
</div>

<!-- ===== Таблица клиентов ===== -->
<div class="row">
  <div class="col-md-12">
    <div class="card-clean">
      <div class="card-header">
        <h3 class="card-title" style="margin:0">Подключённые клиенты</h3>
      </div>
      <div class="card-body">
        {{if .ovstatus}}
          {{if gt (len .ovstatus.ClientList) 0}}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>CN</th>
                    <th>Реальный адрес</th>
                    <th>Вирт. адрес</th>
                    <th class="text-right">KB вход</th>
                    <th class="text-right">KB выход</th>
                    <th>Сессия с</th>
                    <th>Пользователь</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {{range .ovstatus.ClientList}}
                  <tr>
                    <td>{{.CommonName}}</td>
                    <td>{{.RealAddress}}</td>
                    <td>
                      <span class="badge bg-success">{{.VirtualAddress}}</span>
                      <button class="button-transparent button-copy" data-clipboard-text="{{.VirtualAddress}}">
                        <img class="clippy" src="static/img/clippy.svg" width="13" alt="Copy">
                      </button>
                    </td>
                    <td class="text-right">{{printkb .BytesReceived}}</td>
                    <td class="text-right">{{printkb .BytesSent}}</td>
                    <td>{{.ConnectedSince}}</td>
                    <td>{{if eq .Username "UNDEF"}}-{{else}}{{.Username}}{{end}}</td>
                    <td>
                      <a href="javascript:$.MyAPP.Disconnect('{{.CommonName}}')"
                         class="btn btn-xs btn-danger"
                         title="Отключить">Откл.</a>
                    </td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
          {{else}}
            <div class="empty-state" style="display:flex; height:140px">
              Клиентов нет<span class="hint"> (активных сессий не обнаружено)</span>
            </div>
          {{end}}
        {{else}}
          <div class="empty-state" style="display:flex; height:140px">
            Нет данных статуса<span class="hint"> (проверьте management/status)</span>
          </div>
        {{end}}
      </div>
    </div>
  </div>
</div>

<!-- ===== Версия / ОС ===== -->
<div class="row mt-3">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body d-flex align-items-center">
        <img src="/static/img/openvpn-win.svg" alt="OpenVPN" width="40" height="40" style="opacity:.7; margin-right:12px">
        <div>
          <div class="kpi-box__title">Версия OpenVPN</div>
          <div class="kpi-box__value" style="font-size:1.2rem">{{ .ovversion }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="kpi-box__title">Операционная система</div>
        <div class="kpi-box__value" style="font-size:1.2rem">{{ .sysinfo.Os }}</div>
        <div class="kpi-box__muted">Архитектура: {{ .sysinfo.Arch }}</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== События безопасности (24ч) ===== -->
<div class="row mt-3">
  <div class="col-md-12 mb-3">
    <div class="card-clean">
      <div class="card-header"><h3 class="card-title" style="margin:0">События безопасности (24ч)</h3></div>
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center" style="gap:18px">
          <div>
            <div class="kpi-box__title mb-1">Auth fail</div>
            <div class="kpi-box__value" style="font-size:1.1rem" id="sec-auth-fail">0</div>
          </div>
          <div>
            <div class="kpi-box__title mb-1">TLS/verify</div>
            <div class="kpi-box__value" style="font-size:1.1rem" id="sec-tls">0</div>
          </div>
          <div>
            <div class="kpi-box__title mb-1">Keepalive timeouts</div>
            <div class="kpi-box__value" style="font-size:1.1rem" id="sec-keepalive">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="small-muted mt-1" id="metrics-updated">Обновление: —</div>

  <!-- ===== Скрипты ===== -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // Бэкенд-данные
    const ovstatusData = {{ tojson .ovstatus }} || {};
    const ovstats = {{ tojson .ovstats }};
    const metricsData = {{ tojson .metrics }} || {};
    const clients = (metricsData && metricsData.client_breakdown) ? metricsData.client_breakdown : [];

  // Палитра
  const palette = ['#17a2b8', '#28a745', '#6f42c1', '#ffc107', '#e83e8c', '#20c997'];

    // Хранилище, чтобы не плодить графики
    const CHARTS = {};

    function destroyChart(id){
      if (CHARTS[id]) { try { CHARTS[id].destroy(); } catch(e){} delete CHARTS[id]; }
    }
  function showEmpty(id, show=true){
    const canvas = document.getElementById(id);
    const empty = document.querySelector(`[data-empty-for="${id}"]`);
    if (canvas) canvas.style.display = show ? 'none' : 'block';
    if (empty)  empty.style.display  = show ? 'flex' : 'none';
  }
  function isAllZeroOrEmpty(arr){
    if (!arr || !arr.length) return true;
    return arr.every(v => (v===null || v===undefined || v===0));
  }
    function renderBarOrEmpty({id, labels, datasets, stacked=false}){
      const noLabels = !labels || labels.length===0;
      const allZero = !datasets || datasets.length===0 || datasets.every(ds => isAllZeroOrEmpty(ds.data));
      if (noLabels || allZero){
        destroyChart(id);
      showEmpty(id, true);
      return;
    }
    showEmpty(id, false);
    const ctx = document.getElementById(id);
    if (!ctx) return;
    destroyChart(id);
    CHARTS[id] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: { x:{ stacked }, y:{ stacked, beginAtZero:true } },
        plugins: { legend: { position:'bottom' } }
      }
    });
  }

  function setStatusPill(el, state){
    if (!el) return;
    const normalized = (state || 'UNKNOWN').toString().toUpperCase();
    el.classList.remove('pill-ok', 'pill-warn', 'pill-bad');
    let cls = 'pill-warn';
    if (['CONNECTED', 'ACTIVE', 'RUNNING', 'OK'].includes(normalized)) cls = 'pill-ok';
    else if (['WAIT', 'RECONNECTING', 'UNKNOWN'].includes(normalized)) cls = 'pill-warn';
    else cls = 'pill-bad';
    el.classList.add(cls);
    el.textContent = normalized;
  }

  function formatUptime(sec){
    if (sec === undefined || sec === null || isNaN(sec)) return '—';
    const total = Math.max(0, Math.floor(Number(sec)));
    const d = Math.floor(total / 86400);
    const h = Math.floor((total % 86400) / 3600);
    const m = Math.floor((total % 3600) / 60);
    return `${d}d ${h}h ${m}m`;
  }

  function formatTimestamp(ts){
    if (ts === undefined || ts === null) return '—';
    let d;
    if (typeof ts === 'number') d = new Date(ts < 1e12 ? ts * 1000 : ts);
    else {
      d = new Date(ts);
      if (isNaN(d.getTime())) return '—';
    }
    const pad = (n) => `${n}`.padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  // ===== Статус OpenVPN =====
  (function(){
    const statusEl = document.getElementById('ov-status-pill');
    const uptimeEl = document.getElementById('ov-uptime');
    const versionEl = document.getElementById('ov-version');
    const daemonState = (metricsData && metricsData.ovdaemon && metricsData.ovdaemon.state) || metricsData.ovdaemon_state;
    setStatusPill(statusEl, daemonState || 'UNKNOWN');
    const uptimeSeconds = ovstats && ovstats.Uptime !== undefined && ovstats.Uptime !== null ? ovstats.Uptime : null;
    uptimeEl.textContent = formatUptime(uptimeSeconds);
    if (versionEl && metricsData && metricsData.ovversion) versionEl.textContent = metricsData.ovversion;
  })();

  // ===== Management =====
  (function(){
    const mgmt = (metricsData && metricsData.management) || {};
    const reconnects = (metricsData && metricsData.management_reconnects_24h);
    const setPill = (id, val, label) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('pill-ok', 'pill-warn', 'pill-bad');
      let cls = 'pill-warn';
      if (val === undefined || val === null) cls = 'pill-warn';
      else if (val) cls = 'pill-ok';
      else cls = 'pill-bad';
      el.classList.add(cls);
      el.textContent = label;
    };
    setPill('mgmt-state-pill', mgmt.state, 'state');
    setPill('mgmt-log-pill', mgmt.log, 'log');
    setPill('mgmt-bytecount-pill', mgmt.bytecount, 'bytecount');
    const reconnectsEl = document.getElementById('mgmt-reconnects');
    if (reconnectsEl) reconnectsEl.textContent = (reconnects !== undefined && reconnects !== null) ? reconnects : 0;
  })();

  // ===== Очередь широковещания/мультикаста =====
  (function(){
    const valFromMetrics = metricsData && metricsData.global ? metricsData.global.max_bcast_mcast_queue_len : undefined;
    const valFromStatus = ovstatusData && ovstatusData.GlobalStats ? ovstatusData.GlobalStats.maxbcastmcastqueuelen : undefined;
    const queueVal = (valFromMetrics !== undefined && valFromMetrics !== null) ? valFromMetrics : (valFromStatus !== undefined && valFromStatus !== null ? valFromStatus : 0);
    const el = document.getElementById('bcast-queue-val');
    if (!el) return;
    el.textContent = queueVal;
    el.classList.remove('text-success', 'text-danger');
    if (queueVal > 0) el.classList.add('text-danger');
    else el.classList.add('text-success');
  })();

  // ===== События безопасности (24ч) =====
  (function(){
    const sec = (metricsData && metricsData.security_24h) || {};
    const authFail = Number(sec.auth_fail) || 0;
    const tlsErrors = (Number(sec.handshake_errors) || 0) + (Number(sec.tls_verify_fail) || 0) + (Number(sec.crl_reject) || 0);
    const keepalive = Number(sec.keepalive_timeouts) || 0;
    const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    setVal('sec-auth-fail', authFail);
    setVal('sec-tls', tlsErrors);
    setVal('sec-keepalive', keepalive);
  })();

  // ===== Метка обновления =====
  (function(){
    const ts = (metricsData && metricsData.last_seen_ts !== undefined && metricsData.last_seen_ts !== null)
      ? metricsData.last_seen_ts
      : (ovstats && ovstats.CollectedAt);
    const el = document.getElementById('metrics-updated');
    if (el) el.textContent = `Обновление: ${formatTimestamp(ts)}`;
  })();

  // ===== График 1: Суммарный трафик (MB) =====
  (function(){
    const inMB  = ((ovstats && ovstats.BytesIn)  || 0) / 1024 / 1024;
    const outMB = ((ovstats && ovstats.BytesOut) || 0) / 1024 / 1024;
    renderBarOrEmpty({
      id: 'serverTotalsChart',
      labels: ['Вход','Выход'],
      datasets: [{ label:'MB', data:[inMB, outMB], backgroundColor:[palette[0], palette[1]] }]
    });
  })();

  // ===== График 2: Трафик по клиентам (MB) =====
  (function(){
    const labels = clients.map(c => c.common_name || c.real_addr || 'peer');
    const inMB   = clients.map(c => ((c.bytes_in  || 0) / 1024 / 1024));
    const outMB  = clients.map(c => ((c.bytes_out || 0) / 1024 / 1024));
    renderBarOrEmpty({
      id: 'clientTrafficChart',
      labels,
      datasets: [
        { label:'Входящий трафик (MB)', data: inMB,  backgroundColor: palette[0] },
        { label:'Исходящий трафик (MB)', data: outMB, backgroundColor: palette[1] }
      ],
      stacked: true
    });
  })();

  // Копирование адресов (иконка-скрепка)
  (function(){
    const btns = document.querySelectorAll('.button-copy');
    btns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const txt = b.getAttribute('data-clipboard-text') || '';
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(()=> {
          b.querySelector('.clippy').style.opacity = 1;
          setTimeout(()=>{ b.querySelector('.clippy').style.opacity = .6; }, 800);
        });
      });
    });
  })();
</script>

{{end}}
