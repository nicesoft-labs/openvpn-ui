{{ template "layout/base.html" . }}

{{define "head"}}
<title>NiceSOFT NiceVPN UI — Сводка</title>
<style>
  /* ===== Корпоративный нейтральный стиль ===== */
  .kpi-box{border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,.05); padding:16px; background:#fff; height:100%}
  .kpi-box__title{font-size:.9rem; color:#6c757d; margin-bottom:.25rem}
  .kpi-box__value{font-size:1.6rem; font-weight:700; line-height:1.1}
  .kpi-box__muted{color:#6c757d; font-size:.9rem}
  .card-clean{border:1px solid #e9ecef; border-radius:14px; background:#fff; box-shadow:0 3px 10px rgba(0,0,0,.04)}
  .card-clean .card-header{border-bottom:1px solid #eef1f4; background:#fff; border-top-left-radius:14px; border-top-right-radius:14px}
  .card-clean .card-body{padding:16px}
  .metric-card{border:1px solid #e9ecef; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.03); background:#fff}
  .metric-card__header{font-weight:600; margin-bottom:8px}
  .metric-card .chart-wrap{position:relative; height:220px}
  .metric-card canvas{width:100% !important; height:100% !important}
  .status-pill{display:inline-flex; align-items:center; padding:5px 12px; border-radius:999px; font-weight:700; font-size:.9rem; color:#fff; letter-spacing:.03em; text-transform:uppercase}
  .pill-ok{background:#28a745}
  .pill-warn{background:#ffc107; color:#212529}
  .pill-bad{background:#dc3545}
  .small-muted{font-size:.85rem; color:#6c757d}
  .empty-state{display:none; align-items:center; justify-content:center; height:220px; border:2px dashed #e9ecef; border-radius:10px; color:#6c757d; font-size:.95rem; background:#fafafa}
  .empty-state .hint{font-size:.85rem; color:#9aa0a6; margin-left:.5rem}
  .progress-xs{height:10px}
  .progress-number{font-weight:600}
  .table thead th{white-space:nowrap}
  .button-transparent{background:transparent;border:0;padding:0;margin-left:6px}
  .clippy{opacity:.6}
  .clippy:hover{opacity:1}
</style>
{{end}}

{{define "body"}}

<!-- ===== Верхние KPI ===== -->
<div class="row">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Подключённые клиенты</div>
      <div class="kpi-box__value">{{ if .ovstats }}{{ .ovstats.NClients }}{{ else }}0{{ end }}</div>
      <div class="kpi-box__muted">
        Вход: {{ if .ovstats }}{{ printmb .ovstats.BytesIn }}{{ else }}0{{ end }} MB •
        Выход: {{ if .ovstats }}{{ printmb .ovstats.BytesOut }}{{ else }}0{{ end }} MB
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Нагрузка (Load Average)</div>
      <div class="kpi-box__value">1м: {{ .sysinfo.LoadAvg.One }}</div>
      <div class="kpi-box__muted">5м: {{ .sysinfo.LoadAvg.Five }} • 15м: {{ .sysinfo.LoadAvg.Fifteen }}</div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Аптайм ОС</div>
      <div class="kpi-box__value">{{ .sysinfo.UptimeS }}</div>
      <div class="kpi-box__muted">Стабильность хоста</div>
      <div>OpenVPN PID: <span class="kpi-box__value">{{ if .ovpid }}{{ .ovpid }}{{ else }}0{{ end }}</span></div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-3">
    <div class="kpi-box">
      <div class="kpi-box__title">Процессы</div>
      <div class="kpi-box__value" id="process-count">{{ .sysinfo.Processes }}</div>
      <div class="kpi-box__muted">Ядер CPU: <span id="cpu-count">{{ .sysinfo.CPUCount }}</span></div>
    </div>
  </div>
</div>

<!-- ===== Память / Swap ===== -->
<h5 class="mt-2 mb-2">Память</h5>
<div class="row">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            ОЗУ: <b>{{ printmb .sysinfo.Memory.Used }}</b> / {{ printmb .sysinfo.Memory.Total }} MB — {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-primary progress-bar-striped" style="width: {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="progress-group">
          <span class="progress-number">
            Swap: <b>{{ printmb .sysinfo.Swap.Used }}</b> / {{ printmb .sysinfo.Swap.Total }} MB — {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%
          </span>
          <div class="progress progress-xs mt-2">
            <div class="progress-bar bg-secondary progress-bar-striped" style="width: {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%"></div>
          </div>
          {{ if eq .sysinfo.Swap.Total 0 }}
            <div class="small text-warning mt-2">Swap отключён — рекомендовано включить (zram).</div>
          {{ end }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== CPU / Диски ===== -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header d-flex justify-content-between">
        <span>Нагрузка CPU по ядрам</span>
        <span class="small-muted">В процентах</span>
      </div>
      <div class="chart-wrap">
        <canvas id="cpuUsageChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="cpuUsageChart">Нет данных CPU<span class="hint"> (метрика недоступна)</span></div>
      <small class="text-muted d-block mt-2">Доля активного времени (busy %) на ядро.</small>
    </div>
  </div>
  <!-- ===== График: суммарный трафик OpenVPN ===== -->
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">
        Суммарный трафик OpenVPN
        <small class="text-secondary d-block">openvpn_server_bytes_*_total</small>
      </div>
      <div class="chart-wrap">
        <canvas id="serverTotalsChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="serverTotalsChart">Нет данных<span class="hint"> (подключите management/status)</span></div>
      <small class="text-muted d-block mt-2">Источник: management (load-stats) / status.</small>
    </div>
  </div>
</div>

  <div class="row">
    <div class="col-md-12">
      <div class="metric-card">
        <div class="metric-card__header d-flex justify-content-between">
          <span>Использование файловых систем</span>
        <span class="small-muted">Заполненность</span>
      </div>
      <div class="chart-wrap">
        <canvas id="fsUsageChart"></canvas>
      </div>
      <div class="empty-state" data-empty-for="fsUsageChart">Нет данных по дискам<span class="hint"> (мониторинг отключен)</span></div>
      <small class="text-muted d-block mt-2">Процент использования по точкам монтирования.</small>
    </div>
  </div>
</div>

<!-- ===== Сеть: сводка и графики ===== -->
<h5 class="mt-3 mb-2">Сеть</h5>

<div class="row">
  <!-- Conntrack usage -->
  <div class="col-lg-4 col-md-6 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Conntrack usage</div>
      <div class="chart-wrap"><canvas id="conntrackGauge"></canvas></div>
      <div class="empty-state" data-empty-for="conntrackGauge">Нет данных conntrack</div>
    </div>
  </div>

  <!-- Softnet per-CPU -->
  <div class="col-lg-8 col-md-6 mb-4">
    <div class="metric-card">
      <div class="metric-card__header d-flex justify-content-between">
        <span>Softnet per-CPU</span>
        <span class="small-muted">dropped / time_squeezed</span>
      </div>
      <div class="chart-wrap"><canvas id="softnetChart"></canvas></div>
      <div class="empty-state" data-empty-for="softnetChart">Нет данных softnet</div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Interfaces RX/TX -->
  <div class="col-lg-8 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Интерфейсы: RX/TX (MB)</div>
      <div class="chart-wrap"><canvas id="ifaceRxTxChart"></canvas></div>
      <div class="empty-state" data-empty-for="ifaceRxTxChart">Нет данных по интерфейсам</div>
      <small class="text-muted d-block mt-2">Показывает объёмы RX/TX по интерфейсам eth*/en*/tun*/tap*/wg*.</small>
    </div>
  </div>

  <!-- UDP Health -->
  <div class="col-lg-4 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">UDP Health</div>
      <div class="chart-wrap"><canvas id="udpHealthChart"></canvas></div>
      <div class="empty-state" data-empty-for="udpHealthChart">Нет данных UDP</div>
      <small class="text-muted d-block mt-2">Ключевые счётчики: In/OutDatagrams, NoPorts, InErrors, Rcvbuf/SndbufErrors, IgnoredMulti.</small>
    </div>
  </div>
</div>

<!-- Таблица: ключевые сетевые показатели -->
<div class="card-clean mt-2">
  <div class="card-header">
    <h3 class="card-title" style="margin:0">Сетевые показатели (снимок)</h3>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm" id="net-kpis-table">
        <thead>
          <tr>
            <th>Категория</th>
            <th>Показатель</th>
            <th>Значение</th>
            <th>Комментарий</th>
          </tr>
        </thead>
        <tbody>
          <!-- Заполняется JS: renderNetKPIs(netinfoData) -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== Таблица клиентов ===== -->
<div class="row mt-3">
  <div class="col-md-12">
    <div class="card-clean">
      <div class="card-header"><h3 class="card-title" style="margin:0">Подключённые клиенты</h3></div>
      <div class="card-body">
        {{if .ovstatus}}
          {{if gt (len .ovstatus.ClientList) 0}}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>CN</th><th>Реальный адрес</th><th>Вирт. адрес</th>
                    <th class="text-right">KB вход</th><th class="text-right">KB выход</th>
                    <th>Сессия с</th><th>Пользователь</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  {{range .ovstatus.ClientList}}
                  <tr>
                    <td>{{.CommonName}}</td>
                    <td>{{.RealAddress}}</td>
                    <td>
                      <span class="badge bg-success">{{.VirtualAddress}}</span>
                      <button class="button-transparent button-copy" data-clipboard-text="{{.VirtualAddress}}">
                        <img class="clippy" src="static/img/clippy.svg" width="13" alt="Copy">
                      </button>
                    </td>
                    <td class="text-right">{{printkb .BytesReceived}}</td>
                    <td class="text-right">{{printkb .BytesSent}}</td>
                    <td>{{.ConnectedSince}}</td>
                    <td>{{if eq .Username "UNDEF"}}-{{else}}{{.Username}}{{end}}</td>
                    <td><a href="javascript:$.MyAPP.Disconnect('{{.CommonName}}')" class="btn btn-xs btn-danger" title="Отключить">Откл.</a></td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
          {{else}}
            <div class="empty-state" style="display:flex; height:140px">Клиентов нет<span class="hint"> (активных сессий не обнаружено)</span></div>
          {{end}}
        {{else}}
          <div class="empty-state" style="display:flex; height:140px">Нет данных статуса<span class="hint"> (проверьте management/status)</span></div>
        {{end}}
      </div>
    </div>
  </div>
</div>

<!-- ===== Версия / ОС ===== -->
<div class="row mt-3">
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body d-flex align-items-center">
        <img src="/static/img/openvpn-win.svg" alt="OpenVPN" width="40" height="40" style="opacity:.7; margin-right:12px">
        <div>
          <div class="kpi-box__title">Версия OpenVPN</div>
          <!-- Важно: печатаем .ovversion целиком, чтобы не падать на interface{} -->
          <div class="kpi-box__value" style="font-size:1.2rem">{{ .ovversion }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card-clean">
      <div class="card-body">
        <div class="kpi-box__title">Операционная система</div>
        <div class="kpi-box__value" style="font-size:1.2rem">{{ .sysinfo.Os }}</div>
        <div class="kpi-box__muted">Архитектура: {{ .sysinfo.Arch }}</div>
        <div class="kpi-box__muted">Хост: <span id="host-name">{{ .sysinfo.Hostname }}</span></div>
        <div class="kpi-box__muted">Загружен: <span id="boot-time">{{ .sysinfo.BootTime }}</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Отладка системных метрик ===== -->
<div class="card-clean mt-3">
  <div class="card-header"><h3 class="card-title" style="margin:0">Отладка системной информации</h3></div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-4 mb-3">
        <div class="small-muted">Текущее время: <span id="current-time">{{ .sysinfo.CurrentTime }}</span></div>
        <div class="small-muted">Аптайм: <span id="debug-uptime">{{ .sysinfo.UptimeS }}</span></div>
        <div class="small-muted">Процессы: <span id="debug-processes">{{ .sysinfo.Processes }}</span></div>
      </div>
      <div class="col-md-8">
        <pre id="sysinfo-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .sysinfo }}</pre>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-12">
        <div class="small-muted mb-2">Все полученные метрики</div>
        <pre id="metrics-debug" class="bg-light p-3 small" style="max-height:320px; overflow:auto">{{ tojson .metrics }}</pre>
      </div>
    </div>
  </div>
</div>

<!-- ===== Скрипты (без опросов) ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const ovstats     = {{ tojson .ovstats  }} || {};
  const sysinfoData = {{ tojson .sysinfo  }} || {};
  const netinfoData = {{ tojson .netinfo  }} || {};

  const palette = ['#17a2b8', '#28a745', '#6f42c1', '#ffc107', '#e83e8c', '#20c997'];
  const CHARTS = {};
  function destroyChart(id){ if (CHARTS[id]) { try { CHARTS[id].destroy(); } catch(e){} delete CHARTS[id]; } }
  function showEmpty(id, show=true){
    const canvas = document.getElementById(id);
    const empty = document.querySelector(`[data-empty-for="${id}"]`);
    if (canvas) canvas.style.display = show ? 'none' : 'block';
    if (empty)  empty.style.display  = show ? 'flex' : 'none';
  }
  function isAllZeroOrEmpty(arr){ return !arr || !arr.length || arr.every(v => v===null || v===undefined || v===0); }
  function renderBarOrEmpty({id, labels, datasets, stacked=false}){
    if (!labels || !labels.length || !datasets || datasets.length===0 || datasets.every(ds => isAllZeroOrEmpty(ds.data))){
      destroyChart(id); showEmpty(id, true); return;
    }
    showEmpty(id, false);
    const ctx = document.getElementById(id); if (!ctx) return;
    destroyChart(id);
    CHARTS[id] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: { responsive:true, maintainAspectRatio:false, animation:false,
        scales:{ x:{ stacked }, y:{ stacked, beginAtZero:true } },
        plugins:{ legend:{ position:'bottom' } } }
    });
  }

  function renderCpuUsage(info){
    const list = (info && info.cpuList && info.cpuList.List) || [];
    const labels = list.map((_, i) => `CPU${i}`);
    const data = list.map(cpu => {
      const total = (cpu?.User||0)+(cpu?.Sys||0)+(cpu?.Nice||0)+(cpu?.Idle||0)+(cpu?.Wait||0)+(cpu?.Irq||0)+(cpu?.SoftIrq||0)+(cpu?.Stolen||0);
      if (!total) return 0;
      const busy = total - (cpu?.Idle||0);
      return Math.round((busy/total)*1000)/10;
    });
    renderBarOrEmpty({ id:'cpuUsageChart', labels, datasets:[{ label:'Загрузка (%)', data, backgroundColor:palette[0] }] });
  }

  function renderFsUsage(info){
    const fsList = (info && info.fs) || [];
    const labelOf = (fs) => fs.mount || fs.Mount || fs.device || fs.Device || 'fs';
    const usedPctOf = (fs) => (fs.usedPercent ?? fs.UsedPercent ?? 0);
    const labels = fsList.map(labelOf);
    const data   = fsList.map(fs => Math.round(usedPctOf(fs)*10)/10);
    renderBarOrEmpty({ id:'fsUsageChart', labels, datasets:[{ label:'Использовано (%)', data, backgroundColor:palette[2] }] });
  }

  function renderServerTotals(stats){
    const inMB  = ((stats && stats.BytesIn)  || 0) / 1024 / 1024;
    const outMB = ((stats && stats.BytesOut) || 0) / 1024 / 1024;
    renderBarOrEmpty({ id:'serverTotalsChart', labels:['Вход','Выход'],
      datasets:[{ label:'MB', data:[inMB,outMB], backgroundColor:[palette[0],palette[1]] }] });
  }

  // Единоразовый рендер
  renderCpuUsage(sysinfoData);
  renderFsUsage(sysinfoData);
  renderServerTotals(ovstats);

  // Утилиты
  function showEmpty(id, show=true){
    const canvas = document.getElementById(id);
    const empty = document.querySelector(`[data-empty-for="${id}"]`);
    if (canvas) canvas.style.display = show ? 'none' : 'block';
    if (empty)  empty.style.display  = show ? 'flex' : 'none';
  }
  function destroyIfExists(store, id){
    if (store[id]) { try { store[id].destroy(); } catch(e){} delete store[id]; }
  }
  function mb(x){ return Math.round((Number(x||0)/1024/1024)*10)/10; }
  function percent(part, total){ if (!total) return 0; return Math.max(0, Math.min(100, (part/total)*100)); }
  const CHARTS2 = {};

  function renderConntrackGauge(netinfo){
    const cnt = Number(netinfo?.conntrack?.count||0);
    const max = Number(netinfo?.conntrack?.max||0);
    const id = 'conntrackGauge';
    if (!max) { showEmpty(id, true); return; }
    const used = Math.min(percent(cnt, max), 100);
    const free = 100 - used;
    showEmpty(id, false);
    const ctx = document.getElementById(id); if(!ctx) return;
    destroyIfExists(CHARTS2, id);
    CHARTS2[id] = new Chart(ctx, {
      type:'bar',
      data:{ labels:['Conntrack'], datasets:[
        {label:'Used %', data:[used]},
        {label:'Free %', data:[free]}
      ]},
      options:{
        indexAxis:'y', responsive:true, maintainAspectRatio:false,
        animation:false,
        scales:{x:{stacked:true, beginAtZero:true, max:100}, y:{stacked:true}},
        plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{
          label:(c)=> `${c.dataset.label}: ${c.parsed.x.toFixed(1)}% (${cnt}/${max})`
        }}}
      }
    });
  }

  function renderSoftnetBars(netinfo){
    const per = netinfo?.softnet?.per_cpu||[];
    const id = 'softnetChart';
    if (!per.length){ showEmpty(id,true); return; }
    const labels = per.map(x=>'CPU'+x.cpu);
    const dropped = per.map(x=> Number(x.dropped||0));
    const tsq = per.map(x=> Number(x.time_squeezed||0));
    showEmpty(id,false);
    const ctx = document.getElementById(id); if(!ctx) return;
    destroyIfExists(CHARTS2, id);
    CHARTS2[id] = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[
        {label:'dropped', data:dropped},
        {label:'time_squeezed', data:tsq}
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        scales:{x:{stacked:true}, y:{stacked:false, beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  function renderIfaceRxTx(netinfo){
    const ifaces = (netinfo?.ifaces||[]).filter(x => ['eth','en','tun','tap','wg'].some(p=> (x.name||'').startsWith(p)));
    const id = 'ifaceRxTxChart';
    if (!ifaces.length){ showEmpty(id,true); return; }
    const labels = ifaces.map(x=>x.name);
    const rx = ifaces.map(x=> mb(x.rx_bytes));
    const tx = ifaces.map(x=> mb(x.tx_bytes));
    showEmpty(id,false);
    const ctx = document.getElementById(id); if(!ctx) return;
    destroyIfExists(CHARTS2, id);
    CHARTS2[id] = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[
        {label:'RX MB', data:rx},
        {label:'TX MB', data:tx}
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  function renderUdpHealth(netinfo){
    const u = netinfo?.snmp?.udp||{};
    const id = 'udpHealthChart';
    const keys = ['InDatagrams','OutDatagrams','NoPorts','InErrors','RcvbufErrors','SndbufErrors','IgnoredMulti'];
    const vals = keys.map(k => Number(u[k]||0));
    const allZero = !vals.length || vals.every(v=>v===0);
    if (allZero){ showEmpty(id,true); return; }
    showEmpty(id,false);
    const ctx = document.getElementById(id); if(!ctx) return;
    destroyIfExists(CHARTS2, id);
    CHARTS2[id] = new Chart(ctx, {
      type:'bar',
      data:{ labels: keys, datasets:[{label:'count', data: vals}]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{legend:{display:false}}
      }
    });
  }

  function setCellBadge(val, dangerIfGtZero=true){
    const v = Number(val||0);
    if (dangerIfGtZero && v>0) return `<span class="badge bg-danger">${v}</span>`;
    return v===0 ? `<span class="badge bg-success">0</span>` : String(v);
  }

  function tbodyAdd(tbody, cat, key, value, note){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${cat}</td><td>${key}</td><td>${value}</td><td class="small-muted">${note||''}</td>`;
    tbody.appendChild(tr);
  }

  function renderNetKPIs(netinfo){
    const tb = document.querySelector('#net-kpis-table tbody');
    if (!tb) return;
    tb.innerHTML = '';

    // UDP
    const u = netinfo?.snmp?.udp || {};
    tbodyAdd(tb, 'UDP', 'InDatagrams', u.InDatagrams ?? '—', 'входящие дейтаграммы');
    tbodyAdd(tb, 'UDP', 'OutDatagrams', u.OutDatagrams ?? '—', 'исходящие дейтаграммы');
    tbodyAdd(tb, 'UDP', 'NoPorts', setCellBadge(u.NoPorts, false), 'пакеты на неслушаемые порты');
    tbodyAdd(tb, 'UDP', 'InErrors', setCellBadge(u.InErrors), 'ошибки при приёме');
    tbodyAdd(tb, 'UDP', 'RcvbufErrors', setCellBadge(u.RcvbufErrors), 'переполнение приёмного буфера');
    tbodyAdd(tb, 'UDP', 'SndbufErrors', setCellBadge(u.SndbufErrors), 'переполнение отправного буфера');
    tbodyAdd(tb, 'UDP', 'IgnoredMulti', setCellBadge(u.IgnoredMulti, false), 'игнор мультикастов');

    // TCP ext (если есть)
    const te = netinfo?.snmp?.tcpext || {};
    if (te) {
      if (te.ListenOverflows !== undefined) tbodyAdd(tb, 'TCP', 'ListenOverflows', setCellBadge(te.ListenOverflows), 'переполнение очереди accept()');
      if (te.ListenDrops     !== undefined) tbodyAdd(tb, 'TCP', 'ListenDrops', setCellBadge(te.ListenDrops), 'скидывали входящие на listen');
      if (te.RetransSegs     !== undefined) tbodyAdd(tb, 'TCP', 'RetransSegs', te.RetransSegs, 'ретрансмит сегментов (накопительный счётчик)');
    }

    // Conntrack
    const c = netinfo?.conntrack || {};
    const cnt = Number(c.count||0), max = Number(c.max||0);
    const usedPct = max ? (Math.round((cnt/max)*1000)/10) : 0;
    tbodyAdd(tb, 'Conntrack', 'Count', cnt, 'текущие записи');
    tbodyAdd(tb, 'Conntrack', 'Max', max, 'лимит');
    if (c.buckets !== undefined) tbodyAdd(tb, 'Conntrack', 'Buckets', c.buckets, 'хэш-ёмкость');
    tbodyAdd(tb, 'Conntrack', 'Used %', (max?usedPct:'—'), 'использование пула');

    // Softnet total
    const st = netinfo?.softnet?.total || {};
    tbodyAdd(tb, 'Softnet', 'Processed', st.processed ?? '—', 'обработано в софтIRQ');
    tbodyAdd(tb, 'Softnet', 'Dropped', setCellBadge(st.dropped), 'потери до сокетов');
    tbodyAdd(tb, 'Softnet', 'TimeSqueezed', setCellBadge(st.time_squeezed, false), 'давление по времени');

    // Интерфейсы (eth0, tun0 если есть)
    const ifaces = netinfo?.ifaces || [];
    const pick = (name) => ifaces.find(x=>x.name===name);
    ['eth0','tun0'].forEach((n)=>{
      const it = pick(n);
      if (!it) return;
      const rxMB = mb(it.rx_bytes);
      const txMB = mb(it.tx_bytes);
      const errs = (Number(it.rx_errors||0)+Number(it.tx_errors||0));
      const drops= (Number(it.rx_dropped||0)+Number(it.tx_dropped||0));
      tbodyAdd(tb, `Iface ${n}`, 'RX/TX (MB)', `${rxMB} / ${txMB}`, 'накопительно');
      tbodyAdd(tb, `Iface ${n}`, 'Errors', setCellBadge(errs), 'RX+TX ошибки');
      tbodyAdd(tb, `Iface ${n}`, 'Dropped', setCellBadge(drops), 'RX+TX дропы');
      tbodyAdd(tb, `Iface ${n}`, 'Operstate/MTU', `${it.operstate||'—'} / ${it.mtu||'—'}`, '');
    });
  }

  // Рендер сетевого раздела из готового снапшота (без поллинга)
  renderConntrackGauge(netinfoData);
  renderSoftnetBars(netinfoData);
  renderIfaceRxTx(netinfoData);
  renderUdpHealth(netinfoData);
  renderNetKPIs(netinfoData);

  // Копирование адресов (иконка-скрепка)
  (function(){
    const btns = document.querySelectorAll('.button-copy');
    btns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const txt = b.getAttribute('data-clipboard-text') || '';
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(()=> {
          const icon = b.querySelector('.clippy'); if (!icon) return;
          icon.style.opacity = 1; setTimeout(()=>{ icon.style.opacity = .6; }, 800);
        });
      });
    });
  })();
</script>

{{end}}
