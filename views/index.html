{{ template "layout/base.html" . }}

{{define "head"}}
<title>NiceSOFT NiceVPN UI — Сводка</title>
<style>
  .kpi .small-box { border-radius: 12px; }
  .kpi .small-box .inner h3 { font-weight: 700; }
  .metric-card { border: 1px solid #e9ecef; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,.03); }
  .metric-card__header { font-weight: 600; margin-bottom: 8px; }
  .info-box-number3 { font-size: 1.15rem; font-weight: 600; }
  .table thead th { white-space: nowrap; }
  .button-transparent { background: transparent; border: 0; padding: 0 6px; }
</style>
{{end}}

{{define "body"}}

<!-- KPI -->
<div class="row kpi">
  <div class="col-lg-3 col-6">
    <div class="small-box bg-info shadow">
      <div class="inner">
        <h3>Клиенты: {{ .ovstats.NClients }}</h3>
        <div class="info-box-content">
          <span class="info-box-text">Вход: <span class="info-box-number2">{{ printmb .ovstats.BytesIn }} MB</span></span><br>
          <span class="info-box-text">Выход: <span class="info-box-number2">{{ printmb .ovstats.BytesOut }} MB</span></span>
        </div>
      </div>
      <div class="icon"><i class="fa fa-group"></i></div>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box bg-success shadow">
      <div class="inner">
        <h3>Нагрузка</h3>
        <div class="info-box-content">
          <span class="info-box-text">CPU: <b>{{ .sysinfo.CPUList.List | len }}</b></span>
          <span class="info-box-text">LA: <b>{{ .sysinfo.LoadAvg.One }}</b> / <b>{{ .sysinfo.LoadAvg.Five }}</b> / <b>{{ .sysinfo.LoadAvg.Fifteen }}</b></span>
        </div>
      </div>
      <div class="icon"><i class="ion ion-stats-bars"></i></div>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box shadow" style="background-color:#ffc107; color:#212529;">
      <div class="inner">
        <h3>Аптайм ОС</h3>
        <span class="info-box-number">{{ .sysinfo.UptimeS }}</span>
      </div>
      <div class="icon"><i class="ion ion-arrow-graph-up-right"></i></div>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box shadow" style="background-color:#6f42c1; color:#fff;">
      <div class="inner">
        <h3>Время сервера</h3>
        <span class="info-box-number">
          {{ dateformat .sysinfo.CurrentTime "2006-01-02 15:04:05" }}
        </span>
      </div>
      <div class="icon"><i class="fa fa-clock-o"></i></div>
    </div>
  </div>
</div>

<!-- Память/Swap -->
<h3 class="mt-2 mb-2">Память</h3>
<div class="row">
  <div class="col-md-6">
    <div class="card"><div class="card-body">
      <div class="progress-group">
        <span class="progress-number">
          RAM: <b>{{ printmb .sysinfo.Memory.Used }}</b> / {{ printmb .sysinfo.Memory.Total }} MB — {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%
        </span>
        <div class="progress progress-xs">
          <div class="progress-bar bg-primary progress-bar-striped" style="width: {{percent .sysinfo.Memory.Used .sysinfo.Memory.Total}}%"></div>
        </div>
      </div>
    </div></div>
  </div>
  <div class="col-md-6">
    <div class="card"><div class="card-body">
      <div class="progress-group">
        <span class="progress-number">
          Swap: <b>{{ printmb .sysinfo.Swap.Used }}</b> / {{ printmb .sysinfo.Swap.Total }} MB — {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%
        </span>
        <div class="progress progress-xs">
          <div class="progress-bar bg-secondary progress-bar-striped" style="width: {{percent .sysinfo.Swap.Used .sysinfo.Swap.Total}}%"></div>
        </div>
      </div>
    </div></div>
  </div>
</div>

<!-- Графики: минимум и по делу -->
<div class="row">
  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Суммарный трафик OpenVPN</div>
      <canvas id="serverTotalsChart" height="220"></canvas>
      <small class="text-muted d-block mt-2">Источник: management load-stats / status.</small>
    </div>
  </div>

  <div class="col-lg-6 col-md-12 mb-4">
    <div class="metric-card">
      <div class="metric-card__header">Распределение трафика по клиентам</div>
      <canvas id="clientTrafficChart" height="220"></canvas>
      <small class="text-muted d-block mt-2">Показывает входящий/исходящий трафик (MB) по активным сессиям.</small>
    </div>
  </div>
</div>

<!-- Таблица клиентов -->
<div class="row">
  <div class="col-md-12">
    <div class="card card-default">
      <div class="card-header with-border">
        <h3 class="card-title">Подключённые клиенты</h3>
      </div>
      <div class="card-body">
        {{if .ovstatus}}
        <div class="table-responsive">
          <table class="table no-margin">
            <thead>
              <tr>
                <th>Имя (CN)</th>
                <th>Реальный адрес</th>
                <th>Виртуальный адрес</th>
                <th>Получено (KB)</th>
                <th>Отправлено (KB)</th>
                <th>Подключён с</th>
                <th>Пользователь</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {{range .ovstatus.ClientList}}
              <tr>
                <td>{{.CommonName}}</td>
                <td>{{.RealAddress}}</td>
                <td>
                  <span class="badge bg-success">{{.VirtualAddress}}</span>
                  <button class="button-transparent button-copy" data-clipboard-text="{{.VirtualAddress}}">
                    <img class="clippy" src="static/img/clippy.svg" width="13" alt="Скопировать">
                  </button>
                </td>
                <td align="right" style="padding-right:20px">{{printkb .BytesReceived}}</td>
                <td align="right" style="padding-right:20px">{{printkb .BytesSent}}</td>
                <td>{{.ConnectedSince}}</td>
                <td>{{if eq .Username "UNDEF"}}–{{else}}{{.Username}}{{end}}</td>
                <td>
                  <a href="javascript:$.MyAPP.Disconnect('{{.CommonName}}')" class="btn btn-xs btn-danger btn-flat" title="Отключить">X</a>
                </td>
              </tr>
            {{end}}
            </tbody>
          </table>
        </div>
        {{else}}
          Проверьте конфигурацию (данные статуса отсутствуют).
        {{end}}
      </div>
    </div>
  </div>
</div>

<!-- Системная информация -->
<div class="row">
  <div class="col-md-6 col-sm-12 col-12">
    <div class="info-box">
      <span class="info-box-icon bg-warning elevation-1" style="padding:10px;width:100px;height:100px;">
        <img src="/static/img/openvpn-win.svg" alt="OpenVPN" width="74" height="74" style="filter: invert(25%);">
      </span>
      <div class="info-box-content">
        <span class="info-box-text">Версия OpenVPN</span>
        <span class="info-box-number3">{{ .ovversion }}</span>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-sm-12 col-12">
    <div class="info-box">
      <span class="info-box-icon bg-primary elevation-1" style="padding:10px;width:100px;height:100px;">
        <i class="fa fa-gears fa-2x" style="color:#fff;"></i>
      </span>
      <div class="info-box-content">
        <span class="info-box-text">Операционная система</span>
        <span class="info-box-number3">{{ .sysinfo.Os }}</span>
        <span class="info-box-text">Архитектура</span>
        <span class="info-box-number3">{{ .sysinfo.Arch }}</span>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Источники данных
  const ovstats = {{ tojson .ovstats }};
  const metricsData = {{ tojson .metrics }} || {};
  const clients = (metricsData.client_breakdown || []);

  // Палитра
  const palette = ['#17a2b8', '#28a745', '#6f42c1', '#ffc107', '#e83e8c', '#20c997'];

  // 1) Суммарный трафик (MB) — вход / выход
  (function buildServerTotals() {
    const ctx = document.getElementById('serverTotalsChart');
    if (!ctx || !ovstats) return;
    const inMB = (ovstats.BytesIn || 0) / 1024 / 1024;
    const outMB = (ovstats.BytesOut || 0) / 1024 / 1024;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Вход', 'Выход'],
        datasets: [{
          label: 'MB',
          data: [inMB, outMB],
          backgroundColor: [palette[0], palette[1]],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });
  })();

  // 2) Трафик по клиентам (MB) — вход/выход
  (function buildClientTraffic() {
    const ctx = document.getElementById('clientTrafficChart');
    if (!ctx) return;

    const labels = clients.map(c => c.common_name || c.real_addr || 'peer');
    const inMB = clients.map(c => (c.bytes_in || 0) / 1024 / 1024);
    const outMB = clients.map(c => (c.bytes_out || 0) / 1024 / 1024);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Входящий трафик (MB)', data: inMB, backgroundColor: palette[0] },
          { label: 'Исходящий трафик (MB)', data: outMB, backgroundColor: palette[1] }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
        plugins: { legend: { position: 'bottom' } }
      }
    });
  })();
</script>

{{end}}
